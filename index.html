<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .card { @apply bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg transition-all duration-300; }
        .btn-primary { @apply bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto space-y-6">
        <h1 class="text-4xl font-extrabold text-indigo-600 dark:text-indigo-400 text-center">
            Site Stock Management
        </h1>

        <!-- Loading State / Status Card (Visible by default) -->
        <div id="status-card" class="card text-center bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
            <div id="loader" class="flex justify-center items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-indigo-500"></div>
                <p id="status-message" class="text-lg font-medium text-gray-600 dark:text-gray-300">
                    Loading Stock Data and Connecting to Database...
                </p>
            </div>
            <p id="user-id-display" class="mt-2 text-sm text-gray-500 dark:text-gray-400 hidden">
                User ID: <span class="font-mono text-xs"></span>
            </p>
        </div>

        <!-- Main Application Interface (Hidden until connected) -->
        <div id="main-content" class="hidden space-y-6">
            
            <!-- Site Selector and Login -->
            <div class="card flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center space-x-4 mb-4 md:mb-0 w-full md:w-auto">
                    <label for="site-select" class="font-semibold text-lg">Current Site:</label>
                    <select id="site-select" class="p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600"></select>
                    <button id="admin-toggle" class="bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Admin Mode: <span id="admin-status">Off</span>
                    </button>
                </div>
                <div id="admin-login-area" class="hidden mt-4 md:mt-0 w-full md:w-auto">
                    <input type="password" id="admin-password" placeholder="Admin Password" class="p-2 border rounded-lg w-full md:w-48 bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                </div>
            </div>

            <!-- Stock Levels Table -->
            <div class="card overflow-x-auto">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2 border-indigo-200 dark:border-indigo-800">Stock Overview (<span id="current-site-name">...</span>)</h2>
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <th class="px-6 py-3">Item Name</th>
                            <th class="px-6 py-3 text-right">Stock Level</th>
                            <th class="px-6 py-3 text-right">Threshold</th>
                            <th id="cart-header" class="px-6 py-3 text-center hidden">Remove Quantity</th>
                            <th id="action-header" class="px-6 py-3 text-center hidden">Action</th>
                        </tr>
                    </thead>
                    <tbody id="stock-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Stock rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Transaction Area (Visible only when items are in cart) -->
            <div id="transaction-area" class="card hidden">
                <h2 class="text-2xl font-bold mb-4 text-red-600 dark:text-red-400 border-b pb-2 border-red-200 dark:border-red-800">Pending Removal</h2>
                <div id="cart-summary" class="mb-4"></div>
                <button id="confirm-removal-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 mr-4">
                    Confirm Removal of <span id="cart-count">0</span> Items
                </button>
                <button id="clear-cart-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    Clear Cart
                </button>
            </div>

             <!-- Admin Panel (Items Management) - Hidden by default -->
            <div id="admin-panel" class="card hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2 border-emerald-200 dark:border-emerald-800">Admin: Item Definitions</h2>
                <p class="text-sm text-red-400 mb-4">Warning: Editing item definitions globally affects all sites.</p>
                <div id="admin-items-list" class="space-y-4">
                    <!-- Item definition editing forms will go here -->
                </div>
                <button id="add-new-item-btn" class="mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    Add New Item
                </button>
            </div>

        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, writeBatch, Timestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Enable Firebase debug logging
        setLogLevel('debug');


        // --- 1. USER'S APP CONFIGURATION & GLOBAL STATE ---
        
        // Configuration fallback used if the platform variables are invalid or missing.
        const LIVE_FIREBASE_CONFIG_FALLBACK = {
            // This is a dummy, valid configuration to ensure Firebase SDK initialization succeeds.
            apiKey: "AIzaSy_FALLBACK_KEY_DO_NOT_USE_IN_PROD", 
            authDomain: "fallback-domain.firebaseapp.com",
            projectId: "mmstock-fallback",
        };
        
        // --- ADMIN CONFIGURATION ---
        const ADMIN_PASSWORD = 'admin'; // Hardcoded password for quick access
        const SITE_LOCATIONS = ['Dundee', 'Perth', 'Fife', 'Aberdeen', 'Glasgow'];
        const DEFAULT_ITEMS = [
            { id: 'item_glove_m', name: 'Gloves-Medium', threshold: 25 },
            { id: 'item_safety_g', name: 'Safety Glasses', threshold: 50 },
            { id: 'item_hard_hat_w', name: 'Hard Hats-White', threshold: 10 },
            { id: 'item_mask_n95', name: 'Dust Masks-N95', threshold: 100 },
        ];
        
        // --- GLOBAL STATE & FIREBASE INSTANCES ---
        let app, db, auth;
        let userId = 'loading...';
        let isAuthReady = false;
        let isAdmin = false;

        let currentSite = SITE_LOCATIONS[0];
        let stockData = {}; // Stores all stock levels: {itemId: {Dundee: 100, Perth: 50, ...}}
        let itemNames = {}; // Stores all item metadata: {itemId: {name: 'Gloves-M', threshold: 25, docId: '...'}}
        let itemCart = {}; // Stores items being removed: {itemId: count}

        // --- 2. FIREBASE REFERENCE HELPERS (Using the MANDATORY __app_id) ---
        let appId = ''; // Will be set in setupFirebase

        const getStockLevelsRef = () => collection(db, `artifacts/${appId}/public/data/stock_levels`);
        const getItemsRef = () => collection(db, `artifacts/${appId}/public/data/items`);
        const getTransactionsRef = () => collection(db, `artifacts/${appId}/public/data/stock_transactions`);

        // --- 3. UI ELEMENT REFERENCES ---
        const statusCard = document.getElementById('status-card');
        const loader = document.getElementById('loader');
        const statusMessage = document.getElementById('status-message');
        const mainContent = document.getElementById('main-content');
        const siteSelect = document.getElementById('site-select');
        const currentSiteName = document.getElementById('current-site-name');
        const stockTableBody = document.getElementById('stock-table-body');
        const adminToggleBtn = document.getElementById('admin-toggle');
        const adminStatusSpan = document.getElementById('admin-status');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginArea = document.getElementById('admin-login-area');
        const adminPanel = document.getElementById('admin-panel');
        const adminItemsList = document.getElementById('admin-items-list');
        const transactionArea = document.getElementById('transaction-area');
        const cartCountSpan = document.getElementById('cart-count');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- 4. CORE UI FUNCTIONS ---

        const showLoading = (message) => {
            statusMessage.textContent = message;
            loader.classList.remove('hidden');
            mainContent.classList.add('hidden');
            statusCard.classList.remove('bg-red-200', 'border-red-400'); // Clear error state
            statusCard.classList.remove('bg-green-200');
        };

        const showError = (message) => {
            statusMessage.textContent = `CRITICAL ERROR: ${message}`;
            loader.classList.add('hidden');
            statusCard.classList.remove('bg-gray-50');
            statusCard.classList.add('bg-red-200', 'border-red-400', 'text-red-700');
            console.error(`CRITICAL APPLICATION FAILURE: ${message}`);
        };

        const showConnected = (configSource) => {
            statusMessage.textContent = `Database Connected. Live Data Stream Active. (Config Source: ${configSource})`;
            statusCard.classList.remove('bg-gray-50');
            statusCard.classList.add('bg-green-200', 'text-green-800');
            loader.classList.add('hidden');
            mainContent.classList.remove('hidden');
        };

        // --- 5. DATA RENDERING AND LOGIC ---

        function renderSiteSelect() {
            siteSelect.innerHTML = SITE_LOCATIONS.map(site => 
                `<option value="${site}" ${site === currentSite ? 'selected' : ''}>${site}</option>`
            ).join('');
            currentSiteName.textContent = currentSite;
        }

        function renderStockTable() {
            stockTableBody.innerHTML = '';
            let cartActive = Object.keys(itemCart).length > 0;
            
            // Toggle visibility of transaction area and cart columns
            transactionArea.classList.toggle('hidden', !cartActive);
            document.getElementById('cart-header').classList.toggle('hidden', !cartActive);
            document.getElementById('action-header').classList.toggle('hidden', cartActive);

            const itemIds = Object.keys(itemNames).sort();

            if (itemIds.length === 0) {
                 stockTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No items defined. Check Admin Panel or refresh after a few seconds.</td></tr>`;
                 return;
            }

            itemIds.forEach(itemId => {
                const item = itemNames[itemId];
                const siteStocks = stockData[itemId] || {};
                const level = siteStocks[currentSite] || 0;
                const threshold = item.threshold || 0;
                const isLow = level <= threshold;
                const cartQty = itemCart[itemId] || 0;
                
                let rowClass = isLow ? 'bg-red-50 dark:bg-red-900/50' : 'hover:bg-gray-50 dark:hover:bg-gray-700';

                let rowHtml = `
                    <tr class="${rowClass}">
                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${item.name}</td>
                        <td class="px-6 py-4 text-right ${isLow ? 'text-red-500 font-bold' : ''}">${level}</td>
                        <td class="px-6 py-4 text-right text-gray-500">${threshold}</td>
                `;

                // Removal Cart View (if cart is active)
                if (cartActive) {
                    rowHtml += `
                        <td class="px-6 py-4 text-center">
                            ${cartQty > 0 ? `<span class="font-bold text-red-600">${cartQty}</span>` : '0'}
                            <button onclick="decrementCart('${itemId}')" class="ml-2 text-red-500 hover:text-red-700 disabled:opacity-50" ${cartQty === 0 ? 'disabled' : ''}>-</button>
                        </td>
                    `;
                } 
                // Action/Input View (if cart is inactive)
                else {
                    rowHtml += `
                        <td class="px-6 py-4 text-center">
                            <input type="number" id="qty-${itemId}" min="1" max="${level}" placeholder="Qty" class="w-20 p-1 border rounded-lg bg-gray-50 dark:bg-gray-700 text-center" value="">
                            <button onclick="addToCart('${itemId}')" class="ml-2 btn-primary py-1 px-2 text-sm">Remove</button>
                            <button onclick="restock('${itemId}')" class="ml-2 bg-green-500 hover:bg-green-600 text-white py-1 px-2 rounded-lg text-sm">Restock</button>
                        </td>
                    `;
                }

                rowHtml += `</tr>`;
                stockTableBody.insertAdjacentHTML('beforeend', rowHtml);
            });

            if (cartActive) {
                renderCartSummary();
            }
        }
        
        function renderCartSummary() {
            let totalItems = 0;
            let cartHtml = Object.keys(itemCart).map(itemId => {
                const qty = itemCart[itemId];
                totalItems += qty;
                return `<p class="text-sm">• ${itemNames[itemId]?.name}: <span class="font-bold">${qty}</span> removed.</p>`;
            }).join('');

            document.getElementById('cart-summary').innerHTML = cartHtml;
            cartCountSpan.textContent = totalItems;
        }

        // --- 6. EVENT HANDLERS (GLOBAL) ---
        
        window.addToCart = (itemId) => {
            const input = document.getElementById(`qty-${itemId}`);
            const qty = parseInt(input.value, 10);
            const currentLevel = (stockData[itemId] || {})[currentSite] || 0;

            if (qty > 0 && qty <= currentLevel) {
                itemCart[itemId] = (itemCart[itemId] || 0) + qty;
                input.value = ''; // Clear input
                renderStockTable();
            } else if (qty > currentLevel) {
                 console.warn(`Cannot remove ${qty}: only ${currentLevel} in stock.`);
            }
        };

        window.decrementCart = (itemId) => {
            if (itemCart[itemId] && itemCart[itemId] > 0) {
                itemCart[itemId] -= 1;
                if (itemCart[itemId] === 0) {
                    delete itemCart[itemId];
                }
                renderStockTable();
            }
        };

        window.clearCart = () => {
            itemCart = {};
            renderStockTable();
        };

        window.restock = async (itemId) => {
            const input = document.getElementById(`qty-${itemId}`);
            const qty = parseInt(input.value, 10);

            if (qty <= 0 || isNaN(qty)) {
                console.warn("Invalid restock quantity.");
                return;
            }

            const currentLevel = (stockData[itemId] || {})[currentSite] || 0;
            const newLevel = currentLevel + qty;

            try {
                // Update stock level for the current site
                const stockDocRef = doc(getStockLevelsRef(), itemId);
                await updateDoc(stockDocRef, { [currentSite]: newLevel });
                
                // Record the transaction
                await setDoc(doc(getTransactionsRef()), {
                    itemId: itemId,
                    site: currentSite,
                    quantity: qty,
                    type: 'restock',
                    timestamp: Timestamp.now(),
                    userId: userId,
                });

                input.value = ''; // Clear input
                console.log(`Restocked ${qty} of ${itemNames[itemId].name} at ${currentSite}`);
            } catch(e) {
                console.error("Restock failed:", e);
            }
        };

        document.getElementById('confirm-removal-btn').addEventListener('click', async () => {
            const batch = writeBatch(db);
            const transactionDoc = doc(getTransactionsRef());
            const transactionEntries = [];

            try {
                for (const itemId in itemCart) {
                    const removeQty = itemCart[itemId];
                    const currentLevel = (stockData[itemId] || {})[currentSite] || 0;
                    const newLevel = currentLevel - removeQty;

                    if (newLevel < 0) {
                        console.error(`Attempted over-removal for ${itemNames[itemId].name}. Aborting batch.`);
                        throw new Error(`Over-removal attempt for ${itemNames[itemId].name}`);
                    }

                    // 1. Update stock level
                    const stockDocRef = doc(getStockLevelsRef(), itemId);
                    batch.update(stockDocRef, { [currentSite]: newLevel });

                    // 2. Record transaction entry
                    transactionEntries.push({
                        itemId: itemId,
                        quantity: removeQty,
                        type: 'removal',
                    });
                }

                // 3. Commit the batch updates
                await batch.commit();

                // 4. Record the overall transaction
                await setDoc(transactionDoc, {
                    site: currentSite,
                    entries: transactionEntries,
                    timestamp: Timestamp.now(),
                    userId: userId,
                });

                window.clearCart();
                console.log('Removal confirmed and transactions recorded.');

            } catch (e) {
                console.error("Transaction failed:", e);
                // In a real app, you might revert local state or inform the user
            }
        });


        // Handle Site Change
        siteSelect.addEventListener('change', (e) => {
            currentSite = e.target.value;
            currentSiteName.textContent = currentSite;
            renderStockTable();
        });

        // Handle Admin Toggle
        adminToggleBtn.addEventListener('click', () => {
            if (isAdmin) {
                isAdmin = false;
                adminStatusSpan.textContent = 'Off';
                adminPanel.classList.add('hidden');
                adminLoginArea.classList.add('hidden');
                adminPasswordInput.value = '';
                console.log("Admin mode disabled.");
            } else {
                adminLoginArea.classList.remove('hidden');
            }
        });

        // Handle Admin Login
        adminPasswordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (adminPasswordInput.value === ADMIN_PASSWORD) {
                    isAdmin = true;
                    adminStatusSpan.textContent = 'On';
                    adminPanel.classList.remove('hidden');
                    adminLoginArea.classList.add('hidden');
                    renderAdminItems();
                    console.log("Admin mode enabled.");
                } else {
                    console.error("Incorrect Admin Password");
                    adminPasswordInput.value = '';
                }
            }
        });

        // --- 7. DATA LISTENERS (REAL-TIME) ---

        // Listener for Item Metadata (The names and thresholds)
        function setupItemsListener() {
            const itemsQuery = query(getItemsRef());
            onSnapshot(itemsQuery, (snapshot) => {
                itemNames = {};
                snapshot.forEach(doc => {
                    itemNames[doc.id] = { ...doc.data(), docId: doc.id };
                });
                console.log("Item metadata updated:", itemNames);
                renderStockTable();
                if (isAdmin) renderAdminItems();
            }, (error) => {
                console.error("Error setting up items listener:", error);
            });
        }

        // Listener for Stock Levels
        function setupStockLevelsListener() {
            const stockQuery = query(getStockLevelsRef());
            onSnapshot(stockQuery, (snapshot) => {
                stockData = {};
                snapshot.forEach(doc => {
                    stockData[doc.id] = doc.data();
                });
                console.log("Stock levels updated:", stockData);
                renderStockTable();
            }, (error) => {
                console.error("Error setting up stock levels listener:", error);
            });
        }
        
        // --- 8. INITIAL DATA SEEDING (Run once on connect if data is missing) ---

        async function seedInitialData() {
            const batch = writeBatch(db);
            let needsCommit = false;

            // Seed Item Definitions
            const itemsSnap = await new Promise(resolve => {
                // Attach a one-time listener to get current state (or null if error/unauthorized)
                const unsubscribe = onSnapshot(getItemsRef(), (snap) => {
                    unsubscribe(); // Stop listening after first data snapshot
                    resolve(snap);
                }, () => resolve({ empty: true })); // Handle error as empty for graceful seed attempt
            });
            
            if (itemsSnap.empty) {
                console.log("Seeding default items...");
                DEFAULT_ITEMS.forEach(item => {
                    const docRef = doc(getItemsRef(), item.id);
                    batch.set(docRef, { name: item.name, threshold: item.threshold });
                    needsCommit = true;
                });
            }

            // Seed Stock Levels (Initial stock of 100 for all sites/items)
            if (needsCommit) {
                await batch.commit();
                console.log("Default items seeded.");
            }
            
            // Re-run batch for stock levels
            const stockBatch = writeBatch(db);
            let stockNeedsCommit = false;
            
            const stockSnap = await new Promise(resolve => {
                const unsubscribe = onSnapshot(getStockLevelsRef(), (snap) => {
                    unsubscribe();
                    resolve(snap);
                }, () => resolve({ empty: true }));
            });

            if (stockSnap.empty) {
                 console.log("Seeding initial stock levels...");
                 // Use items from the snap if available, otherwise fall back to our hardcoded defaults
                 const currentItems = itemsSnap.empty ? DEFAULT_ITEMS : itemsSnap.docs.map(d => ({id: d.id}));

                 currentItems.forEach(item => {
                    const stockUpdate = {};
                    SITE_LOCATIONS.forEach(site => {
                        stockUpdate[site] = 100; // Default level
                    });
                    const docRef = doc(getStockLevelsRef(), item.id);
                    stockBatch.set(docRef, stockUpdate);
                    stockNeedsCommit = true;
                });
            }
            
            if (stockNeedsCommit) {
                 await stockBatch.commit();
                 console.log("Initial stock levels seeded.");
            }
        }


        // --- 9. ADMIN PANEL FUNCTIONS ---

        function renderAdminItems() {
            adminItemsList.innerHTML = '';
            const itemIds = Object.keys(itemNames).sort();

            itemIds.forEach(itemId => {
                const item = itemNames[itemId];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center space-x-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
                itemDiv.innerHTML = `
                    <input type="text" id="name-${itemId}" value="${item.name}" placeholder="Item Name" class="w-1/3 p-2 border rounded-lg bg-white dark:bg-gray-600">
                    <input type="number" id="threshold-${itemId}" value="${item.threshold}" min="1" placeholder="Threshold" class="w-24 p-2 border rounded-lg bg-white dark:bg-gray-600">
                    <button onclick="saveItem('${itemId}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Save</button>
                    <button onclick="deleteItem('${itemId}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Delete</button>
                `;
                adminItemsList.appendChild(itemDiv);
            });
        }

        window.saveItem = async (itemId) => {
            const name = document.getElementById(`name-${itemId}`).value;
            const threshold = parseInt(document.getElementById(`threshold-${itemId}`).value, 10);
            
            if (!name || isNaN(threshold) || threshold < 1) {
                console.error("Invalid item details.");
                return;
            }

            try {
                const docRef = doc(getItemsRef(), itemId);
                await updateDoc(docRef, { name, threshold });
                console.log(`Item ${name} saved.`);
            } catch (e) {
                console.error("Failed to save item:", e);
            }
        };

        window.deleteItem = async (itemId) => {
            // Note: Using console.warn instead of confirm() for non-blocking UI
            console.warn(`Attempting to delete ${itemNames[itemId].name}. (If this were a real application, a modal confirmation would appear here)`);

            try {
                // Delete Item Definition
                await deleteDoc(doc(getItemsRef(), itemId));
                
                // Delete Stock Level Document
                await deleteDoc(doc(getStockLevelsRef(), itemId));

                console.log(`Item ${itemId} deleted.`);
            } catch (e) {
                console.error("Failed to delete item:", e);
            }
        };

        document.getElementById('add-new-item-btn').addEventListener('click', () => {
            const newItemId = `item_${Date.now()}`;
            const newDiv = document.createElement('div');
            newDiv.className = 'flex items-center space-x-4 p-3 bg-yellow-50 dark:bg-yellow-900/50 rounded-lg';
            newDiv.innerHTML = `
                <input type="text" id="name-${newItemId}" value="New Item" placeholder="Item Name" class="w-1/3 p-2 border rounded-lg bg-white dark:bg-gray-600">
                <input type="number" id="threshold-${newItemId}" value="10" min="1" placeholder="Threshold" class="w-24 p-2 border rounded-lg bg-white dark:bg-gray-600">
                <button onclick="commitNewItem('${newItemId}')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Create</button>
                <button onclick="this.parentNode.remove()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Cancel</button>
            `;
            adminItemsList.prepend(newDiv);
        });

        window.commitNewItem = async (itemId) => {
            const name = document.getElementById(`name-${itemId}`).value;
            const threshold = parseInt(document.getElementById(`threshold-${itemId}`).value, 10);

            if (!name || isNaN(threshold) || threshold < 1) {
                console.error("Invalid item details for creation.");
                return;
            }

            const batch = writeBatch(db);
            
            // Create Item Definition
            const itemRef = doc(getItemsRef(), itemId);
            batch.set(itemRef, { name, threshold });

            // Create Initial Stock Level (100 for all sites)
            const stockUpdate = {};
            SITE_LOCATIONS.forEach(site => { stockUpdate[site] = 100; });
            const stockRef = doc(getStockLevelsRef(), itemId);
            batch.set(stockRef, stockUpdate);

            try {
                await batch.commit();
                console.log(`New item ${name} created successfully.`);
            } catch (e) {
                console.error("Failed to create new item:", e);
            }
        };

        // --- 10. CORE FIREBASE SETUP (FALLBACK LOGIC) ---
        async function setupFirebase() {
            showLoading("Initializing Firebase...");
            let firebaseConfig;
            let configSource = 'Platform Variable';

            try {
                // 1. Get mandatory global variables provided by the platform (with robust checks)
                appId = typeof __app_id === 'string' && __app_id.length > 0 ? __app_id : 'default-app-id';

                // Check for config string and token
                let configString = typeof __firebase_config === 'string' && __firebase_config.length > 0 ? __firebase_config : null;
                const initialAuthToken = typeof __initial_auth_token === 'string' && __initial_auth_token.length > 0 ? __initial_auth_token : null;
                
                
                // --- ROBUST CONFIGURATION HANDLING ---
                if (configString) {
                    try {
                        // Try to parse the platform config
                        firebaseConfig = JSON.parse(configString);
                        
                        if (!firebaseConfig || !firebaseConfig.apiKey) {
                            throw new Error("Missing API Key after parse.");
                        }

                    } catch (e) {
                        // Platform string exists but is invalid JSON or invalid structure -> FALLBACK
                        console.warn(`[WARN] Platform config string failed validation/parse: ${e.message}. Falling back to hardcoded config.`);
                        firebaseConfig = LIVE_FIREBASE_CONFIG_FALLBACK;
                        configSource = 'Hardcoded Fallback (Parse Failed)';
                    }
                } else {
                    // Platform string is missing or empty -> FALLBACK
                    console.warn("[WARN] Platform variable __firebase_config is missing or empty. Falling back to hardcoded config.");
                    firebaseConfig = LIVE_FIREBASE_CONFIG_FALLBACK;
                    configSource = 'Hardcoded Fallback (Variable Missing)';
                }
                
                // 2. Initialize App and Services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 3. Authentication: Use custom token ONLY if using platform config, otherwise use anonymous.
                showLoading("Authenticating User...");
                
                let user;
                if (configSource === 'Platform Variable' && initialAuthToken) {
                    const credentials = await signInWithCustomToken(auth, initialAuthToken);
                    user = credentials.user;
                } else {
                    // Always sign in anonymously if using fallback config or token is missing
                    const credentials = await signInAnonymously(auth);
                    user = credentials.user;
                }

                // 4. Update state and start data stream
                if (user) {
                    userId = user.uid; 
                    isAuthReady = true;
                    userIdDisplay.querySelector('span').textContent = userId;
                    userIdDisplay.classList.remove('hidden');

                    showLoading("Seeding default data...");
                    await seedInitialData();

                    showLoading("Setting up real-time listeners...");
                    setupItemsListener();
                    setupStockLevelsListener();
                    
                    showConnected(configSource); // Show the successful config source

                    // Initial UI Render
                    renderSiteSelect();

                } else {
                    throw new Error('Authentication Failed: Could not get user credential.');
                }

            } catch (error) {
                // If any part of the setup fails, show a prominent error message
                showError(`Setup Failed: ${error.message}.`);
            }
        }

        // Start the application
        setupFirebase();
    </script>
</body>
</html>
