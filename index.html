<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Stock Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --danger: #ef4444;
            --danger-light: #f87171;
            --success: #10b981;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: var(--primary); color: white; padding: 8px 16px; border-radius: 8px; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger); color: white; padding: 8px 16px; border-radius: 8px; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: var(--danger-light); }
        .input-text { border: 1px solid #d1d5db; padding: 8px 12px; border-radius: 8px; width: 100%; }
        .low-stock { background-color: #fee2e2; color: #991b1b; font-weight: 600; }
        .pending-removal-item { background-color: #fffbeb; border-left: 4px solid #f59e0b; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 12px 16px; text-align: left; }
        th { background-color: #e5e7eb; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        tr:nth-child(even) { background-color: #f9fafb; }
        tr:last-child td:first-child { border-bottom-left-radius: 8px; }
        tr:last-child td:last-child { border-bottom-right-radius: 8px; }
        .table-container { overflow-x: auto; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Site Stock Management Dashboard</h1>

        <div id="auth-status" class="mb-4 text-sm text-gray-600">
            Connecting to database...
        </div>
        <div id="loading" class="text-center py-8 text-lg font-medium text-indigo-600 hidden">
            <div class="animate-spin inline-block w-6 h-6 border-4 border-indigo-500 border-t-transparent rounded-full mr-2"></div>
            Loading stock data...
        </div>
        <div id="error-message" class="card p-4 mb-4 bg-red-100 text-red-700 hidden"></div>

        <!-- Main Stock View -->
        <div id="main-view" class="space-y-6 hidden">
            <div class="card p-5 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div class="mb-4 sm:mb-0">
                    <label for="site-select" class="block text-sm font-medium text-gray-700 mb-1">Current Site</label>
                    <select id="site-select" class="input-text w-full sm:w-auto"></select>
                </div>
                <div>
                    <button id="admin-mode-toggle" class="btn-primary">Admin Mode: Off</button>
                </div>
            </div>

            <div class="card table-container">
                <table id="stock-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Item</th>
                            <th>Current Stock</th>
                            <th>Low Threshold</th>
                            <th class="rounded-tr-lg">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Stock rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Pending Removal Cart -->
            <div id="removal-cart" class="card p-5 hidden">
                <h3 class="text-xl font-semibold mb-3 border-b pb-2 text-gray-800">Pending Removal</h3>
                <div id="pending-list" class="space-y-3 mb-4">
                    <p class="text-gray-500" id="empty-cart-message">No items staged for removal.</p>
                </div>
                <button id="confirm-removal-btn" class="btn-danger w-full sm:w-auto" disabled>
                    Confirm Removal of 0 Items
                </button>
            </div>
        </div>

        <!-- Admin Panel (Initially Hidden) -->
        <div id="admin-panel" class="mt-8 card p-5 space-y-4 hidden">
            <h2 class="text-2xl font-bold text-gray-800">Admin Panel (Manage Items)</h2>

            <!-- Item List -->
            <div id="admin-item-list" class="space-y-3">
                <!-- Item management rows will be inserted here -->
            </div>

            <!-- Add New Item Form -->
            <div class="pt-4 border-t mt-4">
                <h3 class="text-xl font-semibold mb-3">Add New Item</h3>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <input type="text" id="new-item-name" placeholder="Item Name (e.g., Safety Goggles)" class="input-text flex-grow">
                    <input type="number" id="new-item-threshold" placeholder="Low Threshold (e.g., 50)" value="50" class="input-text w-full sm:w-40">
                    <button id="add-new-item-btn" class="btn-primary w-full sm:w-auto">Add Item</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global state for application
        let firebaseApp, db, auth, userId = null;
        let isAuthReady = false;
        let siteData = {}; // Stores all stock levels: { siteId: { itemId: quantity } }
        let itemDefinitions = {}; // Stores item details: { itemId: { name: '...', threshold: 50 } }
        let currentSite = 'Dundee';
        let isBatching = false;
        let adminMode = false;

        const sites = ['Dundee', 'Perth', 'Edinburgh', 'Glasgow'];
        const pendingRemoval = {}; // { itemId: quantity }

        // --- Core Firebase Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const authStatusEl = document.getElementById('auth-status');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error-message');
        const mainViewEl = document.getElementById('main-view');

        // Firestore Paths (CRITICAL for security rules)
        const itemDefsPath = `/artifacts/${appId}/public/data/item_definitions`;
        const stockLevelsDocPath = `/artifacts/${appId}/public/data/stock_levels/levels`;

        // Utility to display errors
        function displayError(message) {
            console.error(message);
            errorEl.textContent = `Error: ${message}`;
            errorEl.classList.remove('hidden');
            loadingEl.classList.add('hidden');
        }

        // --- Initialization ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                authStatusEl.textContent = 'Firebase Config Missing. Using Anonymous Fallback.';
                // We cannot proceed without a config, even a fallback is not possible
                // If config is missing, the application will not run. We must wait for the environment.
                displayError("Firebase configuration is missing. Cannot initialize Firestore.");
                return;
            }

            try {
                // Initialize App and Services
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);
                setLogLevel('error'); // Only log errors to keep console clean

                // Sign in with platform token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    authStatusEl.textContent = 'Connected (Authenticated)';
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    authStatusEl.textContent = 'Connected (Anonymous Fallback)';
                    console.warn("Signed in anonymously as no custom token was available.");
                }

                // Wait for auth state to be ready
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log(`User ID: ${userId}`);
                        startListeners();
                        // This is a one-time operation after auth is successful
                        seedDefaultData();
                        mainViewEl.classList.remove('hidden');
                        loadingEl.classList.add('hidden');
                    } else {
                         // Should not happen as we force anonymous sign-in
                        displayError("Authentication failed. Cannot access Firestore.");
                    }
                });


            } catch (e) {
                displayError(`Firebase Initialization Failed: ${e.message}`);
            }
        }

        // --- Data Seeding ---
        async function seedDefaultData() {
            const itemColRef = collection(db, itemDefsPath);
            const itemsSnapshot = await getDocs(itemColRef);

            if (itemsSnapshot.empty) {
                console.log("Seeding default data...");
                const batch = writeBatch(db);

                const defaultItems = [
                    { id: 'item_gloves', name: 'Safety Gloves', threshold: 50 },
                    { id: 'item_glasses', name: 'Safety Glasses', threshold: 30 },
                    { id: 'item_hats', name: 'Hard Hats', threshold: 25 }
                ];

                defaultItems.forEach(item => {
                    const itemRef = doc(db, `${itemDefsPath}/${item.id}`);
                    batch.set(itemRef, { name: item.name, threshold: item.threshold, id: item.id });
                });

                // Set initial stock (100 for all items, all sites)
                const initialStock = {};
                sites.forEach(site => {
                    initialStock[site] = {};
                    defaultItems.forEach(item => {
                        initialStock[site][item.id] = 100;
                    });
                });

                const stockRef = doc(db, stockLevelsDocPath);
                batch.set(stockRef, initialStock);

                try {
                    await batch.commit();
                    console.log("Default data seeded successfully.");
                } catch (e) {
                    displayError(`Failed to seed data: ${e.message}`);
                }
            } else {
                console.log("Existing data found. Skipping seed.");
            }
        }

        // --- Firestore Listeners ---
        function startListeners() {
            // Listener for Item Definitions
            onSnapshot(collection(db, itemDefsPath), (snapshot) => {
                const newDefs = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    newDefs[doc.id] = { ...data, id: doc.id };
                });
                itemDefinitions = newDefs;
                renderStockTable();
                if (adminMode) renderAdminPanel();
            }, (error) => displayError(`Error loading item definitions: ${error.message}`));

            // Listener for Stock Levels
            onSnapshot(doc(db, stockLevelsDocPath), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    siteData = docSnapshot.data();
                } else {
                    siteData = {};
                    console.warn("Stock levels document does not exist.");
                }
                renderStockTable();
            }, (error) => displayError(`Error loading stock levels: ${error.message}`));
        }


        // --- Stock Update Logic (CRITICAL: Uses Transaction) ---
        async function updateStockInFirestore(itemId, change) {
            if (!isAuthReady) return displayError("Authentication not ready. Cannot update stock.");

            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockRef);

                    if (!stockDoc.exists()) {
                        throw "Stock levels document does not exist!";
                    }

                    const currentLevels = stockDoc.data();
                    const siteLevels = currentLevels[currentSite] || {};
                    const currentStock = siteLevels[itemId] || 0;
                    const newStock = Math.max(0, currentStock + change);

                    // Update the local site's stock level for this item
                    siteLevels[itemId] = newStock;
                    currentLevels[currentSite] = siteLevels;

                    // Write the entire updated map back to the document
                    transaction.set(stockRef, currentLevels);
                });
                console.log(`Stock for ${itemId} updated successfully (Change: ${change}).`);

            } catch (e) {
                displayError(`Transaction Failed (Stock Update): ${e.message}`);
                // Re-enable buttons if transaction failed
                document.querySelectorAll('button[data-action]').forEach(btn => btn.disabled = false);
            }
        }

        // --- UI Rendering ---

        // Site Dropdown Setup
        const siteSelectEl = document.getElementById('site-select');
        sites.forEach(site => {
            const option = document.createElement('option');
            option.value = site;
            option.textContent = site;
            siteSelectEl.appendChild(option);
        });
        siteSelectEl.value = currentSite;
        siteSelectEl.addEventListener('change', (e) => {
            currentSite = e.target.value;
            renderStockTable();
            updateRemovalCartUI(); // Reset cart view on site switch
        });

        function renderStockTable() {
            const tableBody = document.querySelector('#stock-table tbody');
            tableBody.innerHTML = '';
            const itemIds = Object.keys(itemDefinitions).sort((a, b) => itemDefinitions[a].name.localeCompare(itemDefinitions[b].name));

            if (itemIds.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">No items defined yet. Please check Admin Panel.</td></tr>';
                return;
            }

            itemIds.forEach(itemId => {
                const item = itemDefinitions[itemId];
                const siteLevels = siteData[currentSite] || {};
                const currentStock = siteLevels[itemId] || 0;
                const isLow = currentStock <= item.threshold;

                const row = document.createElement('tr');
                row.className = isLow ? 'low-stock' : '';

                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${currentStock}</td>
                    <td>${item.threshold}</td>
                    <td>
                        <div class="flex space-x-2 items-center">
                            <input type="number" data-item-id="${itemId}" class="input-text w-20 text-center quantity-input" placeholder="Qty" value="1">
                            <button class="btn-primary restock-btn" data-item-id="${itemId}">Restock</button>
                            <button class="btn-danger remove-btn" data-item-id="${itemId}">Remove</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Re-attach event listeners after rendering
            document.querySelectorAll('.restock-btn').forEach(btn => btn.addEventListener('click', handleRestock));
            document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', handleStageRemoval));
        }

        // --- Event Handlers ---

        function getQuantity(itemId) {
            const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
            const quantity = parseInt(input?.value, 10);
            return (quantity > 0) ? quantity : 1;
        }

        function handleRestock(e) {
            const itemId = e.target.getAttribute('data-item-id');
            const quantity = getQuantity(itemId);
            updateStockInFirestore(itemId, quantity);
        }

        function handleStageRemoval(e) {
            const itemId = e.target.getAttribute('data-item-id');
            const quantity = getQuantity(itemId);

            if (pendingRemoval[itemId]) {
                pendingRemoval[itemId] += quantity;
            } else {
                pendingRemoval[itemId] = quantity;
            }

            // Clear input after staging
            document.querySelector(`.quantity-input[data-item-id="${itemId}"]`).value = 1;
            updateRemovalCartUI();
        }

        function updateRemovalCartUI() {
            const listEl = document.getElementById('pending-list');
            const confirmBtn = document.getElementById('confirm-removal-btn');
            const itemIds = Object.keys(pendingRemoval);
            let totalItems = 0;

            listEl.innerHTML = '';
            document.getElementById('empty-cart-message')?.remove();

            if (itemIds.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500" id="empty-cart-message">No items staged for removal.</p>';
                confirmBtn.textContent = 'Confirm Removal of 0 Items';
                confirmBtn.disabled = true;
                document.getElementById('removal-cart').classList.add('hidden');
                return;
            }

            document.getElementById('removal-cart').classList.remove('hidden');

            itemIds.forEach(itemId => {
                const quantity = pendingRemoval[itemId];
                if (quantity > 0) {
                    const item = itemDefinitions[itemId];
                    totalItems += quantity;
                    const div = document.createElement('div');
                    div.className = 'pending-removal-item p-3 flex justify-between items-center rounded';
                    div.innerHTML = `
                        <span>${item ? item.name : itemId} (${currentSite}): <strong>${quantity}</strong> removed</span>
                        <button class="text-sm text-red-600 hover:text-red-800 clear-item-btn" data-item-id="${itemId}">Clear</button>
                    `;
                    listEl.appendChild(div);
                }
            });

            confirmBtn.textContent = `Confirm Removal of ${totalItems} Items`;
            confirmBtn.disabled = totalItems === 0;

            document.querySelectorAll('.clear-item-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const itemId = e.target.getAttribute('data-item-id');
                delete pendingRemoval[itemId];
                updateRemovalCartUI();
            }));
        }

        // --- Confirm Removal Handler (Batch Write) ---
        document.getElementById('confirm-removal-btn').addEventListener('click', async () => {
            if (!isAuthReady || isBatching) return;
            isBatching = true;
            document.getElementById('confirm-removal-btn').disabled = true;

            const itemsToCommit = { ...pendingRemoval };
            Object.keys(pendingRemoval).forEach(key => delete pendingRemoval[key]);
            updateRemovalCartUI(); // Clear cart UI immediately

            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockRef);
                    if (!stockDoc.exists()) throw "Stock levels document does not exist!";

                    const currentLevels = stockDoc.data();
                    let siteLevels = currentLevels[currentSite] || {};

                    for (const itemId in itemsToCommit) {
                        const quantityToRemove = itemsToCommit[itemId];
                        const currentStock = siteLevels[itemId] || 0;
                        const newStock = Math.max(0, currentStock - quantityToRemove);
                        siteLevels[itemId] = newStock;
                    }

                    currentLevels[currentSite] = siteLevels;
                    transaction.set(stockRef, currentLevels);
                });
                console.log(`Batch removal committed successfully.`);
            } catch (e) {
                displayError(`Transaction Failed (Batch Removal): ${e.message}`);
                // In a real app, you might want to restore the pending items here.
            } finally {
                isBatching = false;
                document.getElementById('confirm-removal-btn').disabled = false;
            }
        });

        // --- Admin Mode Logic ---

        document.getElementById('admin-mode-toggle').addEventListener('click', () => {
            const password = prompt("Enter Admin Password:");
            if (password === 'admin') {
                adminMode = true;
                document.getElementById('admin-mode-toggle').textContent = 'Admin Mode: On (Click to exit)';
                document.getElementById('admin-panel').classList.remove('hidden');
                renderAdminPanel();
            } else if (adminMode) {
                adminMode = false;
                document.getElementById('admin-mode-toggle').textContent = 'Admin Mode: Off';
                document.getElementById('admin-panel').classList.add('hidden');
            } else {
                alert("Incorrect password.");
            }
        });

        function renderAdminPanel() {
            const listEl = document.getElementById('admin-item-list');
            listEl.innerHTML = '';
            const itemIds = Object.keys(itemDefinitions).sort((a, b) => itemDefinitions[a].name.localeCompare(itemDefinitions[b].name));

            itemIds.forEach(itemId => {
                const item = itemDefinitions[itemId];
                const div = document.createElement('div');
                div.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 p-3 card';
                div.innerHTML = `
                    <input type="text" data-field="name" value="${item.name}" placeholder="Item Name" class="input-text flex-grow">
                    <input type="number" data-field="threshold" value="${item.threshold}" placeholder="Threshold" class="input-text w-full sm:w-32">
                    <button class="btn-primary save-def-btn" data-item-id="${itemId}">Save</button>
                    <button class="btn-danger delete-def-btn" data-item-id="${itemId}">Delete</button>
                `;
                listEl.appendChild(div);
            });

            document.querySelectorAll('.save-def-btn').forEach(btn => btn.addEventListener('click', handleSaveItemDefinition));
            document.querySelectorAll('.delete-def-btn').forEach(btn => btn.addEventListener('click', handleDeleteItemDefinition));
        }

        async function handleSaveItemDefinition(e) {
            const itemId = e.target.getAttribute('data-item-id');
            const parent = e.target.closest('div');
            const newName = parent.querySelector('[data-field="name"]').value;
            const newThreshold = parseInt(parent.querySelector('[data-field="threshold"]').value, 10);

            if (!newName || isNaN(newThreshold) || newThreshold < 0) {
                return alert("Please enter a valid name and a non-negative threshold.");
            }

            const itemRef = doc(db, `${itemDefsPath}/${itemId}`);
            try {
                // Update the item definition document
                await setDoc(itemRef, { name: newName, threshold: newThreshold, id: itemId }, { merge: true });
                console.log(`Item definition for ${itemId} updated.`);
            } catch (e) {
                displayError(`Failed to save item definition: ${e.message}`);
            }
        }

        // --- Add New Item ---
        document.getElementById('add-new-item-btn').addEventListener('click', async () => {
            const nameEl = document.getElementById('new-item-name');
            const thresholdEl = document.getElementById('new-item-threshold');
            const name = nameEl.value.trim();
            const threshold = parseInt(thresholdEl.value, 10);

            if (!name || isNaN(threshold) || threshold < 0) {
                return alert("Please enter a valid item name and a non-negative threshold.");
            }

            const itemId = 'item_' + name.toLowerCase().replace(/[^a-z0-9]+/g, '_');
            const itemRef = doc(db, `${itemDefsPath}/${itemId}`);
            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Check/Add Item Definition
                    transaction.set(itemRef, { name: name, threshold: threshold, id: itemId });

                    // 2. Update Stock Levels for all sites
                    const stockDoc = await transaction.get(stockRef);
                    if (stockDoc.exists()) {
                        const currentLevels = stockDoc.data();
                        sites.forEach(site => {
                            if (!currentLevels[site]) currentLevels[site] = {};
                            // Set initial stock to 100 for the new item at all sites
                            currentLevels[site][itemId] = 100;
                        });
                        transaction.set(stockRef, currentLevels);
                    }
                });

                nameEl.value = '';
                thresholdEl.value = '50';
                console.log(`New item ${name} added successfully.`);
            } catch (e) {
                displayError(`Failed to add new item in transaction: ${e.message}`);
            }
        });

        async function handleDeleteItemDefinition(e) {
            const itemId = e.target.getAttribute('data-item-id');
            if (!confirm(`Are you sure you want to delete ${itemDefinitions[itemId]?.name}? This will remove it from all sites.`)) {
                return;
            }

            const itemDefRef = doc(db, `${itemDefsPath}/${itemId}`);
            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Delete Item Definition
                    transaction.delete(itemDefRef);

                    // 2. Remove Item from Stock Levels
                    const stockDoc = await transaction.get(stockRef);
                    if (stockDoc.exists()) {
                        const currentLevels = stockDoc.data();
                        sites.forEach(site => {
                            if (currentLevels[site] && currentLevels[site][itemId] !== undefined) {
                                delete currentLevels[site][itemId];
                            }
                        });
                        transaction.set(stockRef, currentLevels);
                    }
                });
                console.log(`Item ${itemId} deleted successfully.`);
            } catch (e) {
                displayError(`Failed to delete item in transaction: ${e.message}`);
            }
        }

        // Initial setup call
        loadingEl.classList.remove('hidden');
        initializeFirebase();

    </script>
</body>
</html>
