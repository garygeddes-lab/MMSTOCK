<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitchell & Murdoch Stock Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Updated Color Variables to use Teal/Cyan */
        :root {
            --primary: #06b6d4; /* Cyan 500 */
            --primary-light: #22d3ee; /* Cyan 400 */
            --danger: #ef4444;
            --danger-light: #f87171;
            --success: #10b981;
            --primary-text: #0891b2; /* Cyan 600 for text */
        }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { 
            background-color: white; 
            border-radius: 12px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* Stronger shadow */
        }
        
        .btn-primary { 
            background-color: var(--primary); 
            color: white; 
            padding: 10px 20px; 
            border-radius: 8px; 
            transition: all 0.2s;
            font-weight: 600;
        }
        .btn-primary:hover:not(:disabled) { 
            background-color: var(--primary-light); 
            box-shadow: 0 4px 6px -1px rgba(6, 182, 212, 0.5); 
        }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background-color 0.2s;
            font-weight: 600;
        }
        .btn-secondary:hover { background-color: #d1d5db; }
        
        .btn-danger { 
            background-color: var(--danger); 
            color: white; 
            padding: 10px 20px; 
            border-radius: 8px; 
            transition: background-color 0.2s;
            font-weight: 600;
        }
        .btn-danger:hover { background-color: var(--danger-light); }
        
        .input-text { 
            border: 1px solid #d1d5db; 
            padding: 10px 12px; 
            border-radius: 8px; 
            width: 100%; 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-text:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.3);
        }
        
        /* Status and Alerts */
        .low-stock { background-color: #fef2f2; color: #b91c1c; font-weight: 600; border-left: 4px solid #ef4444; }
        .pending-removal-item { background-color: #ecfeff; border-left: 4px solid var(--primary); }
        .log-restock { color: var(--success); font-weight: 600; }
        .log-removal { color: var(--danger); font-weight: 600; }
        .log-mass { color: var(--primary-text); font-weight: 600; }

        /* Table Styling */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 14px 16px; text-align: left; }
        th { background-color: #e0f2f1; /* Light cyan header background */
            color: var(--primary-text);
            font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        tr:nth-child(even) { background-color: #f7f7f7; }
        
        /* Ensure table corners are rounded */
        .table-container { overflow-x: auto; border-radius: 12px; }
        .table-container table { border-radius: 12px; overflow: hidden; }

        .site-button.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(6, 182, 212, 0.5);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-4xl font-extrabold text-gray-800 pb-2 mb-4 sm:mb-0">Mitchell & Murdoch Stock Control</h1>
            <div class="space-x-2">
                <button id="view-toggle-btn" class="btn-secondary">Go to Admin Panel</button>
            </div>
        </header>

        <div id="auth-status" class="mb-4 text-sm text-gray-600">
            Connecting to database...
        </div>
        <div id="loading" class="text-center py-8 text-xl font-medium text-cyan-600 hidden">
            <div class="animate-spin inline-block w-6 h-6 border-4 border-cyan-500 border-t-transparent rounded-full mr-2"></div>
            Loading stock data...
        </div>
        <div id="error-message" class="card p-4 mb-6 bg-red-100 text-red-700 font-semibold hidden"></div>

        <!-- --- USER DASHBOARD VIEW --- -->
        <div id="dashboard-view" class="space-y-8 hidden">
            
            <!-- Site Selection Buttons -->
            <div class="card p-4">
                <h2 class="text-xl font-semibold mb-3 text-primary-text">Select Current Site</h2>
                <div id="site-buttons" class="flex flex-wrap gap-3">
                    <!-- Site buttons rendered here -->
                </div>
            </div>

            <!-- Stock Table -->
            <div class="card table-container">
                <h2 class="text-2xl font-bold p-4 bg-gray-50 rounded-t-xl text-gray-700 border-b">Stock Levels at <span id="current-site-display">Dundee</span></h2>
                <table id="stock-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg w-1/3">Item Name</th>
                            <th class="w-1/4">Current Stock</th>
                            <th class="rounded-tr-lg w-auto">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Stock rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Pending Removal Cart -->
            <div id="removal-cart" class="card p-5 hidden">
                <h3 class="text-2xl font-bold mb-4 border-b pb-2 text-primary-text flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.865 14.281A2 2 0 0116.327 23H7.673a2 2 0 01-1.808-1.719L5 7m4 0V4a2 2 0 114 0v3m3 0V4a2 2 0 10-4 0v3m-3 0V4a2 2 0 10-4 0v3m-3 0h16"/>
                    </svg>
                    Pending Removal Cart
                </h3>
                <div id="pending-list" class="space-y-3 mb-6">
                    <p class="text-gray-500" id="empty-cart-message">No items staged for removal.</p>
                </div>
                <button id="confirm-removal-btn" class="btn-danger w-full" disabled>
                    Confirm Removal of 0 Items
                </button>
            </div>
        </div>
        
        <!-- --- ADMIN PANEL VIEW --- -->
        <div id="admin-view" class="space-y-8 hidden">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-2">Administrator Panel</h2>

            <!-- Item Definition Management -->
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-primary-text mb-4">Item Definitions (Master List)</h3>
                
                <div id="admin-item-list" class="space-y-4">
                    <!-- Item management rows will be inserted here -->
                </div>

                <!-- Add New Item Form -->
                <div class="pt-6 border-t mt-4">
                    <h4 class="text-xl font-semibold mb-3">Add New Inventory Item</h4>
                    <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4">
                        <input type="text" id="new-item-name" placeholder="Item Name (e.g., Safety Goggles)" class="input-text flex-grow">
                        <input type="number" id="new-item-threshold" placeholder="Threshold (e.g., 50)" value="50" class="input-text w-full md:w-32">
                        <button id="add-new-item-btn" class="btn-primary w-full md:w-32 text-sm">Add Item</button>
                    </div>
                </div>
            </div>

            <!-- Mass Stock Update -->
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-primary-text mb-4">Mass Stock Update (All Sites)</h3>
                <div class="space-y-4">
                    <label for="mass-update-select" class="block text-sm font-medium text-gray-700">Select Item to Adjust</label>
                    <select id="mass-update-select" class="input-text"></select>

                    <label for="mass-update-quantity" class="block text-sm font-medium text-gray-700">Quantity Change (e.g., 50 for restock, -10 for removal)</label>
                    <input type="number" id="mass-update-quantity" placeholder="Quantity Change" class="input-text" value="10">

                    <label for="mass-update-reason" class="block text-sm font-medium text-gray-700">Reason for Mass Update (required for log)</label>
                    <input type="text" id="mass-update-reason" placeholder="e.g., Annual count correction" class="input-text">

                    <button id="commit-mass-update" class="btn-danger w-full">Commit Mass Update Across ALL Sites</button>
                </div>
            </div>

            <!-- Transaction Log -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-primary-text">Transaction Log (Audit)</h3>
                    <button id="download-log-btn" class="btn-secondary text-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Download CSV
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="log-table" class="min-w-full">
                        <thead>
                            <tr>
                                <th class="rounded-tl-lg">Timestamp</th>
                                <th>User/Reason</th>
                                <th>Site</th>
                                <th>Item</th>
                                <th class="rounded-tr-lg">Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Log entries inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

    </div>

    <!-- Custom Modal Structure (Replaces alert, confirm, and prompt) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="card p-6 w-11/12 max-w-md" role="alertdialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-message">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>

            <div id="modal-input-container" class="mb-4 hidden">
                <input type="text" id="modal-input" class="input-text" placeholder="Enter value" autocomplete="off">
            </div>

            <div id="modal-actions" class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 hidden">Cancel</button>
                <button id="modal-confirm-btn" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, writeBatch, runTransaction, setDoc, getDocs, setLogLevel, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // --- END Imports ---
        
        // --- GLOBAL STATE & CONFIG ---
        let firebaseApp, db, auth, userId = null;
        let isAuthReady = false;
        let siteData = {}; // Stores all stock levels: { siteId: { itemId: quantity } }
        let itemDefinitions = {}; // Stores item details: { itemId: { name: '...', threshold: 50 } }
        let transactions = []; // Stores the audit log
        let currentSite = 'Dundee';
        let isBatching = false;
        let adminMode = false; // Not used for UI state, but for permissions
        let viewState = 'dashboard'; // 'dashboard' or 'admin'

        const sites = ['Dundee', 'Perth', 'Edinburgh', 'Glasgow'];
        const pendingRemoval = {}; // { itemId: quantity }

        // --- Core Firebase Setup & Global Elements ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // HARDCODED CONFIG (CRITICAL FIX)
        const userProvidedConfigString = '{"apiKey": "AIzaSyAxS1OGhr1bmnm572PRdozNK8mz-sG-PEE", "authDomain": "mmstock-8bcdf.firebaseapp.com", "projectId": "mmstock-8bcdf", "storageBucket": "mmstock-8bcdf.firebasestorage.app", "messagingSenderId": "935228101629", "appId": "1:935228101629:web:766421e0da43becc323f94", "measurementId": "G-NWJ4Z7ZHT8"}';
        const rawConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? __firebase_config : userProvidedConfigString;
        let firebaseConfig = null;
        if (rawConfig) {
            try { firebaseConfig = JSON.parse(rawConfig); } catch (e) { console.error("Failed to parse __firebase_config string:", e); }
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI Elements
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error-message');
        const dashboardViewEl = document.getElementById('dashboard-view');
        const adminViewEl = document.getElementById('admin-view');
        const currentSiteDisplay = document.getElementById('current-site-display');
        const viewToggleBtn = document.getElementById('view-toggle-btn');
        
        // Firestore Paths
        const itemDefsPath = `/artifacts/${appId}/public/data/item_definitions`;
        const stockLevelsDocPath = `/artifacts/${appId}/public/data/stock_levels/levels`;
        const transactionsPath = `/artifacts/${appId}/public/data/transactions`; // New Log Path

        // Utility to display errors
        function displayError(message) {
            console.error(message);
            errorEl.textContent = `Error: ${message}`;
            errorEl.classList.remove('hidden');
            loadingEl.classList.add('hidden');
        }

        // --- Custom Modal (Updated for Generic Prompt) ---
        function showModal({ title, message, type = 'alert', onSubmit = () => {}, onCancel = () => {}, inputType = 'text', inputPlaceholder = 'Enter value' }) {
            const modalEl = document.getElementById('custom-modal');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const inputContainerEl = document.getElementById('modal-input-container');
            const inputEl = document.getElementById('modal-input');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            // Reset UI
            titleEl.textContent = title;
            messageEl.textContent = message;
            inputContainerEl.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            confirmBtn.className = 'btn-primary';
            inputEl.value = '';
            
            // Setup based on type
            if (type === 'confirm' || type === 'prompt') {
                cancelBtn.classList.remove('hidden');
                confirmBtn.textContent = (type === 'confirm') ? 'Confirm' : 'Submit';
                confirmBtn.className = type === 'confirm' ? 'btn-danger' : 'btn-primary';
            } else {
                confirmBtn.textContent = 'OK';
            }

            if (type === 'prompt') {
                inputContainerEl.classList.remove('hidden');
                inputEl.focus();
                inputEl.type = inputType;
                inputEl.placeholder = inputPlaceholder;
            }

            // Handlers
            confirmBtn.onclick = () => {
                modalEl.classList.add('hidden');
                const result = type === 'prompt' ? inputEl.value : true;
                onSubmit(result);
            };

            cancelBtn.onclick = () => {
                modalEl.classList.add('hidden');
                onCancel();
            };

            modalEl.classList.remove('hidden');
        }

        // --- View State Manager ---
        function setViewState(newState) {
            viewState = newState;
            if (viewState === 'admin') {
                dashboardViewEl.classList.add('hidden');
                adminViewEl.classList.remove('hidden');
                viewToggleBtn.textContent = 'Go to User Dashboard';
                viewToggleBtn.classList.remove('btn-secondary');
                viewToggleBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'px-4', 'py-2', 'rounded-lg');
                if (adminMode) renderAdminPanel();
            } else { // dashboard
                adminViewEl.classList.add('hidden');
                dashboardViewEl.classList.remove('hidden');
                viewToggleBtn.textContent = 'Go to Admin Panel';
                viewToggleBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'text-white', 'px-4', 'py-2', 'rounded-lg');
                viewToggleBtn.classList.add('btn-secondary');
            }
        }

        // --- Core Firebase Initialization ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                return displayError("Firebase configuration is missing. Cannot initialize Firestore.");
            }

            try {
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);
                setLogLevel('debug');

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        startListeners();
                        seedDefaultData();
                        setViewState('dashboard');
                        loadingEl.classList.add('hidden');
                    } else {
                        displayError("Authentication failed. Cannot access Firestore.");
                    }
                });

            } catch (e) {
                displayError(`Firebase Initialization Failed: ${e.message}`);
            }
        }

        // --- Data Seeding ---
        async function seedDefaultData() {
            try {
                const itemColRef = collection(db, itemDefsPath);
                const itemsSnapshot = await getDocs(itemColRef);

                if (itemsSnapshot.empty) {
                    const batch = writeBatch(db);
                    const defaultItems = [
                        { id: 'item_gloves', name: 'Safety Gloves', threshold: 50 },
                        { id: 'item_glasses', name: 'Safety Glasses', threshold: 30 },
                        { id: 'item_hats', name: 'Hard Hats', threshold: 25 }
                    ];

                    defaultItems.forEach(item => {
                        const itemRef = doc(db, `${itemDefsPath}/${item.id}`);
                        batch.set(itemRef, { name: item.name, threshold: item.threshold, id: item.id });
                    });

                    const initialStock = {};
                    sites.forEach(site => {
                        initialStock[site] = {};
                        defaultItems.forEach(item => { initialStock[site][item.id] = 100; });
                    });

                    const stockRef = doc(db, stockLevelsDocPath);
                    batch.set(stockRef, initialStock);

                    await batch.commit();
                    console.log("Default data seeded successfully.");
                }
            } catch (e) { displayError(`Failed to seed data: ${e.message}`); }
        }

        // --- Firestore Listeners ---
        function startListeners() {
            // Item Definitions
            onSnapshot(collection(db, itemDefsPath), (snapshot) => {
                const newDefs = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    newDefs[doc.id] = { ...data, id: doc.id };
                });
                itemDefinitions = newDefs;
                renderStockTable();
                renderSiteButtons();
                if (viewState === 'admin') renderAdminPanel();
                renderMassUpdateDropdown();
            }, (error) => console.error(`Error loading item definitions: ${error.message}`));

            // Stock Levels
            onSnapshot(doc(db, stockLevelsDocPath), (docSnapshot) => {
                siteData = docSnapshot.exists() ? docSnapshot.data() : {};
                renderStockTable();
            }, (error) => console.error(`Error loading stock levels: ${error.message}`));

            // Transaction Log (Admin only)
            // Note: Cannot use orderBy() on public collection path, sort in memory
            onSnapshot(collection(db, transactionsPath), (snapshot) => {
                transactions = [];
                snapshot.forEach(doc => {
                    transactions.push(doc.data());
                });
                // Sort by timestamp (newest first) in memory
                transactions.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
                if (viewState === 'admin') renderTransactionLog();
            }, (error) => console.error(`Error loading transactions: ${error.message}`));
        }


        // --- LOGGING FUNCTION (New) ---
        async function logTransaction({ site, itemId, change, userName, type, reason = '' }) {
            const currentStock = (siteData[site] && siteData[site][itemId]) || 0;
            const newStock = currentStock + change;
            
            try {
                await addDoc(collection(db, transactionsPath), {
                    timestamp: new Date(),
                    userId: userId,
                    userName: userName || 'System/Admin',
                    site: site,
                    itemId: itemId,
                    itemName: itemDefinitions[itemId]?.name || itemId,
                    change: change,
                    oldStock: currentStock,
                    newStock: newStock,
                    type: type,
                    reason: reason,
                });
            } catch (e) {
                console.error("Failed to log transaction:", e);
            }
        }

        // --- UI Rendering - Dashboard ---

        function renderSiteButtons() {
            const siteButtonsEl = document.getElementById('site-buttons');
            siteButtonsEl.innerHTML = '';
            
            sites.forEach(site => {
                const button = document.createElement('button');
                button.textContent = site;
                button.className = `site-button btn-secondary px-6 py-3 transition ${site === currentSite ? 'active' : ''}`;
                button.dataset.site = site;
                button.onclick = () => {
                    currentSite = site;
                    currentSiteDisplay.textContent = site;
                    renderStockTable();
                    updateRemovalCartUI();
                    renderSiteButtons(); // Re-render to update active state
                };
                siteButtonsEl.appendChild(button);
            });
        }

        function renderStockTable() {
            const tableBody = document.querySelector('#stock-table tbody');
            tableBody.innerHTML = '';
            const itemIds = Object.keys(itemDefinitions).sort((a, b) => itemDefinitions[a].name.localeCompare(itemDefinitions[b].name));
            currentSiteDisplay.textContent = currentSite;

            if (itemIds.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No items defined yet. Please see Admin Panel.</td></tr>';
                return;
            }

            itemIds.forEach(itemId => {
                const item = itemDefinitions[itemId];
                const siteLevels = siteData[currentSite] || {};
                const currentStock = siteLevels[itemId] || 0;
                const isLow = currentStock <= item.threshold;
                const quantityInputId = `qty-${itemId}`;

                const row = document.createElement('tr');
                row.className = isLow ? 'low-stock' : 'bg-white'; 

                // Only two columns are displayed for the user: Item Name and Current Stock
                row.innerHTML = `
                    <td class="font-semibold text-gray-800">${item.name}</td>
                    <td class="font-extrabold text-lg">${currentStock}</td>
                    <td>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center">
                            <input type="number" id="${quantityInputId}" data-item-id="${itemId}" class="input-text w-16 text-center quantity-input p-2 text-base" placeholder="Qty" value="1" min="1">
                            <button class="btn-primary restock-btn text-sm p-2 whitespace-nowrap" data-item-id="${itemId}">Restock</button>
                            <button class="btn-danger remove-btn text-sm p-2 whitespace-nowrap" data-item-id="${itemId}">Remove</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.restock-btn').forEach(btn => btn.addEventListener('click', handleRestock));
            document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', handleStageRemoval));
        }

        function getQuantity(itemId) {
            const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
            const quantity = parseInt(input?.value, 10);
            return (quantity > 0) ? quantity : 1;
        }

        function handleRestock(e) {
            const itemId = e.target.getAttribute('data-item-id');
            const quantity = getQuantity(itemId);
            
            showModal({
                title: "Confirm Restock & User Name",
                message: `You are restocking ${quantity} of ${itemDefinitions[itemId].name} at ${currentSite}. Please enter your name for the audit log.`,
                type: 'prompt',
                inputPlaceholder: "Your Full Name",
                onSubmit: (userName) => {
                    if (userName.trim()) {
                        updateStockAndLog(itemId, quantity, userName.trim(), 'Restock');
                    } else {
                        showModal({ title: "Name Required", message: "Restock cancelled. Name is required for logging.", type: 'alert' });
                    }
                }
            });
        }

        async function updateStockAndLog(itemId, change, userName, type) {
            if (!isAuthReady) return displayError("Authentication not ready. Cannot update stock.");

            const stockRef = doc(db, stockLevelsDocPath);

            try {
                // 1. Run Transaction to update stock level atomically
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockRef);
                    if (!stockDoc.exists()) throw "Stock levels document does not exist!";

                    const currentLevels = stockDoc.data();
                    const siteLevels = currentLevels[currentSite] || {};
                    const currentStock = siteLevels[itemId] || 0;
                    const newStock = Math.max(0, currentStock + change);

                    siteLevels[itemId] = newStock;
                    currentLevels[currentSite] = siteLevels;
                    transaction.set(stockRef, currentLevels);
                });
                
                // 2. Log the successful transaction
                await logTransaction({ 
                    site: currentSite, 
                    itemId: itemId, 
                    change: change, 
                    userName: userName, 
                    type: type 
                });

            } catch (e) {
                displayError(`Transaction Failed (${type} Update): ${e.message}`);
            }
        }
        
        // --- Removal Logic (Modified to stage first) ---
        function handleStageRemoval(e) {
            const itemId = e.target.getAttribute('data-item-id');
            const quantity = getQuantity(itemId);
            
            const availableStock = (siteData[currentSite] && siteData[currentSite][itemId]) || 0;
            const currentlyStaged = pendingRemoval[itemId] || 0;
            const potentialNewStock = availableStock - currentlyStaged - quantity;

            if (potentialNewStock < 0) {
                return showModal({
                    title: "Stock Limit Reached",
                    message: `Cannot stage ${quantity} of ${itemDefinitions[itemId].name} for removal. You only have ${availableStock - currentlyStaged} items remaining after considering the current cart.`,
                    type: 'alert'
                });
            }

            pendingRemoval[itemId] = (pendingRemoval[itemId] || 0) + quantity;

            const inputEl = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
            if(inputEl) inputEl.value = 1;

            updateRemovalCartUI();
        }

        function updateRemovalCartUI() {
            const listEl = document.getElementById('pending-list');
            const confirmBtn = document.getElementById('confirm-removal-btn');
            const itemIds = Object.keys(pendingRemoval).filter(id => pendingRemoval[id] > 0);
            let totalItems = 0;

            listEl.innerHTML = '';
            document.getElementById('empty-cart-message')?.remove();

            if (itemIds.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500" id="empty-cart-message">No items staged for removal.</p>';
                confirmBtn.textContent = 'Confirm Removal of 0 Items';
                confirmBtn.disabled = true;
                document.getElementById('removal-cart').classList.add('hidden');
                return;
            }

            document.getElementById('removal-cart').classList.remove('hidden');

            itemIds.forEach(itemId => {
                const quantity = pendingRemoval[itemId];
                if (quantity > 0) {
                    const item = itemDefinitions[itemId];
                    totalItems += quantity;
                    const div = document.createElement('div');
                    div.className = 'pending-removal-item p-3 flex justify-between items-center rounded-lg shadow-sm';
                    div.innerHTML = `
                        <span class="font-medium text-gray-700">${item ? item.name : itemId} (${currentSite}): <strong class="text-primary-text">${quantity}</strong> staged</span>
                        <button class="text-sm text-red-600 hover:text-red-800 clear-item-btn font-semibold" data-item-id="${itemId}">Clear</button>
                    `;
                    listEl.appendChild(div);
                }
            });

            confirmBtn.textContent = `Confirm Removal of ${totalItems} Items`;
            confirmBtn.disabled = totalItems === 0;

            document.querySelectorAll('.clear-item-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const itemId = e.target.getAttribute('data-item-id');
                delete pendingRemoval[itemId];
                updateRemovalCartUI();
            }));
        }

        // --- Final Removal Confirmation Handler (Prompts for Name) ---
        document.getElementById('confirm-removal-btn').addEventListener('click', () => {
             if (isBatching) return;

             showModal({
                title: "Confirm Removal & User Name",
                message: `Confirm removal of staged items from ${currentSite}. Please enter your name for the audit log.`,
                type: 'prompt',
                inputPlaceholder: "Your Full Name",
                onSubmit: (userName) => {
                    if (userName.trim()) {
                        commitRemovalTransaction(userName.trim());
                    } else {
                        showModal({ title: "Name Required", message: "Removal cancelled. Name is required for logging.", type: 'alert' });
                    }
                }
            });
        });

        async function commitRemovalTransaction(userName) {
            if (!isAuthReady || isBatching) return;
            isBatching = true;
            document.getElementById('confirm-removal-btn').textContent = 'Processing...';

            const itemsToCommit = { ...pendingRemoval };
            Object.keys(pendingRemoval).forEach(key => delete pendingRemoval[key]);
            updateRemovalCartUI(); 

            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockRef);
                    if (!stockDoc.exists()) throw "Stock levels document does not exist!";

                    const currentLevels = stockDoc.data();
                    let siteLevels = currentLevels[currentSite] || {};

                    for (const itemId in itemsToCommit) {
                        const quantityToRemove = itemsToCommit[itemId];
                        const newStock = Math.max(0, (siteLevels[itemId] || 0) - quantityToRemove);
                        siteLevels[itemId] = newStock;
                        
                        // Log each item removal within the transaction scope
                        await logTransaction({
                            site: currentSite,
                            itemId: itemId,
                            change: -quantityToRemove,
                            userName: userName,
                            type: 'Removal'
                        });
                    }

                    currentLevels[currentSite] = siteLevels;
                    transaction.set(stockRef, currentLevels);
                });
                console.log(`Batch removal committed successfully.`);
            } catch (e) {
                displayError(`Transaction Failed (Batch Removal): ${e.message}`);
                // Re-add items to pendingRemoval conceptually if transaction fails (simplified: rely on logs)
            } finally {
                isBatching = false;
            }
        }
        
        // --- Admin View Toggle ---
        viewToggleBtn.addEventListener('click', () => {
            if (viewState === 'dashboard') {
                showModal({
                    title: "Admin Access Required",
                    message: "Enter the admin password to access the Administrator Panel. (Hint: 'admin')",
                    type: 'prompt',
                    inputType: 'password',
                    inputPlaceholder: 'Admin Password',
                    onSubmit: (password) => {
                        if (password === 'admin') {
                            adminMode = true;
                            setViewState('admin');
                        } else {
                            showModal({ title: "Access Denied", message: "Incorrect password.", type: 'alert' });
                        }
                    }
                });
            } else {
                adminMode = false;
                setViewState('dashboard');
            }
        });

        // --- UI Rendering - Admin ---
        function renderAdminPanel() {
            renderItemDefinitions();
            renderTransactionLog();
            renderMassUpdateDropdown();
        }

        function renderItemDefinitions() {
            const listEl = document.getElementById('admin-item-list');
            listEl.innerHTML = '';
            const itemIds = Object.keys(itemDefinitions).sort((a, b) => itemDefinitions[a].name.localeCompare(itemDefinitions[b].name));

            itemIds.forEach(itemId => {
                const item = itemDefinitions[itemId];
                const div = document.createElement('div');
                div.className = 'flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 p-4 card';
                div.innerHTML = `
                    <input type="text" data-field="name" value="${item.name}" placeholder="Item Name" class="input-text flex-grow">
                    <input type="number" data-field="threshold" value="${item.threshold}" placeholder="Threshold" class="input-text w-full sm:w-32">
                    <button class="btn-primary save-def-btn w-full sm:w-24 text-sm" data-item-id="${itemId}">Save</button>
                    <button class="btn-danger delete-def-btn w-full sm:w-24 text-sm" data-item-id="${itemId}">Delete</button>
                `;
                listEl.appendChild(div);
            });

            document.querySelectorAll('.save-def-btn').forEach(btn => btn.addEventListener('click', handleSaveItemDefinition));
            document.querySelectorAll('.delete-def-btn').forEach(btn => btn.addEventListener('click', handleDeleteItemDefinition));
        }

        // Admin: Handle Item Definition Save/Update
        async function handleSaveItemDefinition(e) {
            const itemId = e.target.getAttribute('data-item-id');
            const parent = e.target.closest('div');
            const newName = parent.querySelector('[data-field="name"]').value.trim();
            const newThreshold = parseInt(parent.querySelector('[data-field="threshold"]').value, 10);

            if (!newName || isNaN(newThreshold) || newThreshold < 0) {
                return showModal({ title: "Invalid Input", message: "Please enter a valid item name and a non-negative threshold.", type: 'alert' });
            }

            const itemRef = doc(db, `${itemDefsPath}/${itemId}`);
            try {
                await setDoc(itemRef, { name: newName, threshold: newThreshold, id: itemId }, { merge: true });
                console.log(`Item definition for ${itemId} updated.`);
            } catch (e) { displayError(`Failed to save item definition: ${e.message}`); }
        }
        
        // Admin: Handle Item Deletion
        function handleDeleteItemDefinition(e) {
            const itemId = e.target.getAttribute('data-item-id');
            const itemName = itemDefinitions[itemId]?.name || itemId;

            showModal({
                title: "Confirm Deletion",
                message: `Are you absolutely sure you want to delete "${itemName}"? This action is permanent and will remove the item from ALL sites and from the master list.`,
                type: 'confirm',
                onSubmit: () => { performDeletion(itemId); }
            });
        }
        
        async function performDeletion(itemId) {
            const itemDefRef = doc(db, `${itemDefsPath}/${itemId}`);
            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    transaction.delete(itemDefRef); 

                    const stockDoc = await transaction.get(stockRef);
                    if (stockDoc.exists()) {
                        const currentLevels = stockDoc.data();
                        sites.forEach(site => {
                            if (currentLevels[site] && currentLevels[site][itemId] !== undefined) {
                                delete currentLevels[site][itemId];
                            }
                        });
                        transaction.set(stockRef, currentLevels);
                    }
                });
                console.log(`Item ${itemId} deleted successfully.`);
            } catch (e) { displayError(`Failed to delete item in transaction: ${e.message}`); }
        }


        // Admin: Add New Item
        document.getElementById('add-new-item-btn').addEventListener('click', async () => {
            const nameEl = document.getElementById('new-item-name');
            const thresholdEl = document.getElementById('new-item-threshold');
            const name = nameEl.value.trim();
            const threshold = parseInt(thresholdEl.value, 10);

            if (!name || isNaN(threshold) || threshold < 0) {
                return showModal({ title: "Invalid Input", message: "Please enter a valid item name and a non-negative threshold.", type: 'alert' });
            }

            const itemId = 'item_' + name.toLowerCase().replace(/[^a-z0-9]+/g, '_');
            const itemRef = doc(db, `${itemDefsPath}/${itemId}`);
            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    transaction.set(itemRef, { name: name, threshold: threshold, id: itemId });

                    const stockDoc = await transaction.get(stockRef);
                    const currentLevels = stockDoc.exists() ? stockDoc.data() : {};
                    
                    sites.forEach(site => {
                        if (!currentLevels[site]) currentLevels[site] = {};
                        currentLevels[site][itemId] = 100; // Initial stock
                        
                        // Log initial stock for new item
                        if (!stockDoc.exists() || !(stockDoc.data()[site] && stockDoc.data()[site][itemId] !== undefined)) {
                            logTransaction({
                                site: site,
                                itemId: itemId,
                                change: 100,
                                userName: 'System/Admin',
                                type: 'Initial Stock'
                            });
                        }
                    });
                    transaction.set(stockRef, currentLevels);
                });

                nameEl.value = '';
                thresholdEl.value = '50';
                console.log(`New item ${name} added successfully.`);
            } catch (e) { displayError(`Failed to add new item in transaction: ${e.message}`); }
        });


        // Admin: Transaction Log Rendering
        function renderTransactionLog() {
            const logTableBody = document.querySelector('#log-table tbody');
            logTableBody.innerHTML = '';
            
            transactions.forEach(log => {
                const date = log.timestamp.toDate().toLocaleString();
                let changeClass = '';
                let changeSign = '';

                if (log.type === 'Removal') {
                    changeClass = 'log-removal';
                    changeSign = '';
                } else if (log.type === 'Restock' || log.type === 'Mass Update' || log.type === 'Initial Stock') {
                    changeClass = 'log-restock';
                    changeSign = '+';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${log.userName}</td>
                    <td>${log.site}</td>
                    <td>${log.itemName}</td>
                    <td class="${changeClass}">${changeSign}${log.change}</td>
                `;
                logTableBody.appendChild(row);
            });
        }
        
        // Admin: Download Log to CSV
        document.getElementById('download-log-btn').addEventListener('click', () => {
            if (transactions.length === 0) return;

            const header = ['Timestamp', 'User', 'Site', 'Item', 'Change', 'Old Stock', 'New Stock', 'Type', 'Reason'].join(',');
            const rows = transactions.map(log => [
                `"${log.timestamp.toDate().toLocaleString()}"`,
                `"${log.userName}"`,
                `"${log.site}"`,
                `"${log.itemName}"`,
                log.change,
                log.oldStock,
                log.newStock,
                `"${log.type}"`,
                `"${log.reason}"`
            ].join(','));

            const csvContent = [header, ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "mm_stock_log.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Admin: Mass Update Dropdown
        function renderMassUpdateDropdown() {
            const selectEl = document.getElementById('mass-update-select');
            selectEl.innerHTML = '<option value="">-- Select Item --</option>';

            Object.keys(itemDefinitions).sort((a, b) => itemDefinitions[a].name.localeCompare(itemDefinitions[b].name)).forEach(itemId => {
                const item = itemDefinitions[itemId];
                const option = document.createElement('option');
                option.value = itemId;
                option.textContent = item.name;
                selectEl.appendChild(option);
            });
        }

        // Admin: Commit Mass Update
        document.getElementById('commit-mass-update').addEventListener('click', async (e) => {
            const itemId = document.getElementById('mass-update-select').value;
            const quantity = parseInt(document.getElementById('mass-update-quantity').value, 10);
            const reason = document.getElementById('mass-update-reason').value.trim();

            if (!itemId || isNaN(quantity) || quantity === 0 || !reason) {
                return showModal({ title: "Invalid Input", message: "Please select an item, enter a non-zero quantity, and provide a reason.", type: 'alert' });
            }

            e.target.disabled = true;
            e.target.textContent = 'Processing...';

            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockRef);
                    if (!stockDoc.exists()) throw "Stock levels document does not exist!";

                    const currentLevels = stockDoc.data();
                    
                    sites.forEach(site => {
                        const siteLevels = currentLevels[site] || {};
                        const oldStock = siteLevels[itemId] || 0;
                        const newStock = Math.max(0, oldStock + quantity);

                        siteLevels[itemId] = newStock;
                        currentLevels[site] = siteLevels;
                        
                        // Log transaction for each site
                        logTransaction({
                            site: site,
                            itemId: itemId,
                            change: quantity,
                            userName: 'Admin',
                            type: 'Mass Update',
                            reason: reason
                        });
                    });

                    transaction.set(stockRef, currentLevels);
                });

                showModal({ title: "Success", message: `${itemDefinitions[itemId].name} stock updated by ${quantity} across all sites.`, type: 'alert' });
                document.getElementById('mass-update-select').value = '';
                document.getElementById('mass-update-quantity').value = '10';
                document.getElementById('mass-update-reason').value = '';

            } catch (e) {
                displayError(`Mass Update Failed: ${e.message}`);
            } finally {
                e.target.disabled = false;
                e.target.textContent = 'Commit Mass Update Across ALL Sites';
            }
        });


        // Initial setup call
        loadingEl.classList.remove('hidden');
        initializeFirebase();

    </script>
</body>
</html>
