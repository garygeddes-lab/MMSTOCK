<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitchell & Murdoch Stock Control</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to recognize custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'violet-700': '#6D28D9',
                        'violet-800': '#5B21AA',
                        'teal-600': '#0D9488',
                        'teal-700': '#0F766E',
                    },
                },
            }
        }
    </script>
    <!-- Load React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Firebase SDKs -->
    <script type="module">
        // Importing modules for the Firebase services used in the React component
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, writeBatch, runTransaction, getDocs, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase functions globally for the React component to use
        window.firebase = {
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, onSnapshot, collection, query, writeBatch, runTransaction, getDocs, setDoc, deleteDoc
        };

        // This is a dummy setup for local testing. The actual environment will provide these variables.
        if (typeof window.__firebase_config === 'undefined') {
            console.warn("Using placeholder Firebase config. App may not function correctly without a real configuration.");
            window.__firebase_config = JSON.stringify({
  apiKey: "AIzaSyAxS1OGhr1bmnm572PRdozNK8mz-sG-PEE",
  authDomain: "mmstock-8bcdf.firebaseapp.com",
  projectId: "mmstock-8bcdf",
  storageBucket: "mmstock-8bcdf.firebasestorage.app",
  messagingSenderId: "935228101629",
  appId: "1:935228101629:web:766421e0da43becc323f94",
  measurementId: "G-NWJ4Z7ZHT8"
};
            });
        }
        if (typeof window.__initial_auth_token === 'undefined') {
            console.warn("Using placeholder auth token.");
            window.__initial_auth_token = null; // No token for local placeholder
        }
        if (typeof window.__app_id === 'undefined') {
            window.__app_id = 'mitchell-murdoch-stock-local';
        }

    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
// --- REACT APPLICATION CODE START ---

const { useState, useEffect, useCallback, useMemo } = React;
// Destructure Firebase functions from the global window object set up above
const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, onSnapshot, collection, query, writeBatch, runTransaction, getDocs, setDoc, deleteDoc } = window.firebase;

// --- CONFIGURATION & SETUP ---

// Global Variables are provided by the canvas environment
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'mitchell-murdoch-stock';

// Icons (using Lucide icons via inline SVG equivalents)
const LogOut = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
const CheckCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>;
const Package = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-package"><path d="m7.5 4.27 9 5.15"/><path d="M12 21V9.28"/><path d="M22 11.6V16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-4.4"/><path d="m22 7.7-10-5.71L2 7.7"/><path d="m11 10.21-10-5.71"/><path d="M12 2v10.21"/><path d="M2 12.5v4.5"/><path d="M12 12.5v4.5"/><path d="M22 12.5v4.5"/></svg>;
const MapPin = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-map-pin"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
const List = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-list"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>;
const Lock = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-lock"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
const Truck = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-truck"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15.5 18H20a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2h-3.5"/><path d="M6.5 18a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/><path d="M18.5 18a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>;
const X = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
const Loader2 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-loader-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
const Minus = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-minus"><line x1="5" x2="19" y1="12" y2="12"/></svg>;
const Plus = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-plus"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>;
const ShoppingCart = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-shopping-cart"><circle cx="8" cy="20.5" r="1"/><circle cx="18" cy="20.5" r="1"/><path d="M2.5 2h3.29l.7 2H21l-1.4 6H7.83l-.7 2H2.5"/><path d="M6 14h16v3a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-3z"/></svg>;
const Users = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
const ArrowDown = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrow-down"><line x1="12" x2="12" y1="5" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>;
const ArrowUp = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrow-up"><line x1="12" x2="12" y1="19" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>;


// Hardcoded Master Admin Password for simplicity as requested (Admin users should change this)
const MASTER_PASSWORD = 'admin123';

// Firestore Collection Paths (Public data shared across sites/users)
const getCollectionPath = (db, collectionName) => {
    return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
};

// Colors based on Purple (#6D28D9) and Teal (#0D9488)
const PRIMARY_COLOR = 'bg-violet-700 hover:bg-violet-800';
const ACCENT_COLOR = 'bg-teal-600 hover:bg-teal-700';
const TEXT_COLOR = 'text-gray-800';
const WHITE_TEXT = 'text-white';
const BORDER_COLOR = 'border-violet-700';

const INITIAL_LOCATIONS = [
    { id: 'Dundee', name: 'Dundee' },
    { id: 'Perth', name: 'Perth' },
    { id: 'Fife', name: 'Fife' },
    { id: 'Falkirk', name: 'Falkirk' },
    { id: 'Aberdeen', name: 'Aberdeen' },
];

const INITIAL_ITEMS = [
    { id: 'gloves', name: 'Nitrile Gloves (Box of 100)', unit: 'Box' },
    { id: 'aprons', name: 'Disposable Aprons (Roll of 200)', unit: 'Roll' },
    { id: 'sanitizer', name: 'Hand Sanitizer (500ml)', unit: 'Bottle' },
];

// --- UTILITY COMPONENTS ---

const Button = ({ children, onClick, className = '', disabled = false, icon: Icon }) => (
    <button
        onClick={onClick}
        disabled={disabled}
        className={`flex items-center justify-center space-x-2 px-4 py-2 rounded-lg font-semibold transition duration-150 shadow-md ${disabled ? 'bg-gray-400 cursor-not-allowed' : `${PRIMARY_COLOR} ${WHITE_TEXT}`} ${className}`}
    >
        {Icon && <Icon size={18} />}
        <span>{children}</span>
    </button>
);

const IconButton = ({ children, onClick, className = '', disabled = false, icon: Icon, title }) => (
    <button
        onClick={onClick}
        disabled={disabled}
        title={title}
        className={`p-2 rounded-full transition duration-150 ${disabled ? 'bg-gray-400 cursor-not-allowed' : `${PRIMARY_COLOR} ${WHITE_TEXT} hover:shadow-lg`} ${className}`}
    >
        {Icon && <Icon size={20} />}
        {children}
    </button>
);

const Card = ({ children, title, icon: Icon, className = '' }) => (
    <div className={`bg-white p-6 rounded-xl shadow-lg ${className}`}>
        {title && (
            <h2 className={`text-xl font-bold mb-4 flex items-center ${TEXT_COLOR}`}>
                {Icon && <Icon size={24} className="mr-2 text-teal-600" />}
                {title}
            </h2>
        )}
        {children}
    </div>
);

const Modal = ({ isOpen, onClose, title, children, className = '' }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-50">
            <Card title={title} className={`w-full max-w-lg ${className}`}>
                <div className="absolute top-4 right-4">
                    <IconButton onClick={onClose} icon={X} className="bg-transparent hover:bg-gray-200 text-gray-500 hover:text-gray-700 shadow-none" />
                </div>
                <div className="mt-2">
                    {children}
                </div>
            </Card>
        </div>
    );
};

// --- INITIAL DATA & FIRESTORE HELPER ---

const initializeFirestoreData = async (db, appId) => {
    const batch = writeBatch(db);
    const locationsRef = getCollectionPath(db, 'locations');
    const itemsRef = getCollectionPath(db, 'items');
    const inventoryRef = getCollectionPath(db, 'inventory');

    // 1. Locations
    INITIAL_LOCATIONS.forEach(loc => {
        batch.set(doc(locationsRef, loc.id), loc);
    });

    // 2. Items with initial thresholds
    INITIAL_ITEMS.forEach(item => {
        const minThresholds = {};
        INITIAL_LOCATIONS.forEach(loc => {
            // Sample threshold logic
            minThresholds[loc.id] = item.id === 'gloves' ? 20 : item.id === 'aprons' ? 10 : 5;
        });
        batch.set(doc(itemsRef, item.id), { ...item, minThresholds });
    });

    // 3. Initial Inventory (Level)
    INITIAL_LOCATIONS.forEach(loc => {
        INITIAL_ITEMS.forEach(item => {
            const initialLevel = item.id === 'gloves' ? 150 : item.id === 'aprons' ? 80 : 35;
            batch.set(doc(inventoryRef, `${item.id}-${loc.id}`), {
                itemId: item.id,
                locationId: loc.id,
                level: initialLevel,
                lowStockComment: ''
            });
        });
    });

    try {
        await batch.commit();
        console.log("Initial sample data written to Firestore.");
    } catch (e) {
        console.error("Error writing initial data: ", e);
    }
};

// --- MAIN APPLICATION COMPONENT ---

const App = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [appInitialized, setAppInitialized] = useState(false);
    const [adminPassword, setAdminPassword] = useState('');
    const [isAdmin, setIsAdmin] = useState(false);
    const [activeTab, setActiveTab] = useState('frontend');

    // Real-time Data States
    const [locations, setLocations] = useState([]);
    const [items, setItems] = useState([]);
    const [inventory, setInventory] = useState([]);
    const [transactions, setTransactions] = useState([]);

    // 1. FIREBASE INITIALIZATION & AUTHENTICATION
    useEffect(() => {
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            return;
        }

        try {
            const app = firebase.initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);

            // Authenticate user
            const authenticate = async () => {
                if (initialAuthToken) {
                    await signInWithCustomToken(authInstance, initialAuthToken);
                } else {
                    await signInAnonymously(authInstance);
                }
            };

            onAuthStateChanged(authInstance, (user) => {
                if (user) {
                    setUserId(user.uid);
                    setAuth(authInstance);
                    setDb(dbInstance);
                } else {
                    // Start authentication if not signed in
                    authenticate().catch(e => console.error("Auth error:", e));
                }
            });
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }
    }, []);

    // 2. DATA SUBSCRIPTION & INITIALIZATION
    useEffect(() => {
        if (!db || !userId) return;

        setAppInitialized(false);
        const locationsRef = getCollectionPath(db, 'locations');
        const itemsRef = getCollectionPath(db, 'items');
        const inventoryRef = getCollectionPath(db, 'inventory');
        const transactionsRef = getCollectionPath(db, 'transactions');

        // Check if initial data needs to be seeded (only check 'locations' collection once)
        getDocs(locationsRef).then(snapshot => {
            if (snapshot.empty) {
                console.log("Seeding initial data...");
                initializeFirestoreData(db, appId);
            }
        });

        // Set up real-time listeners (onSnapshot)
        const unsubLocations = onSnapshot(locationsRef, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setLocations(data.sort((a, b) => a.name.localeCompare(b.name)));
            setAppInitialized(true);
        });

        const unsubItems = onSnapshot(itemsRef, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setItems(data.sort((a, b) => a.name.localeCompare(b.name)));
        });

        const unsubInventory = onSnapshot(inventoryRef, (snapshot) => {
            setInventory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });

        const unsubTransactions = onSnapshot(query(transactionsRef), (snapshot) => {
            setTransactions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });

        return () => {
            unsubLocations();
            unsubItems();
            unsubInventory();
            unsubTransactions();
        };
    }, [db, userId]);

    // Computed Inventory Map for quick lookup
    const inventoryMap = useMemo(() => {
        const map = {};
        inventory.forEach(inv => {
            map[`${inv.locationId}-${inv.itemId}`] = inv;
        });
        return map;
    }, [inventory]);

    // Computed Items Map for quick lookup
    const itemMap = useMemo(() => {
        const map = {};
        items.forEach(item => {
            map[item.id] = item;
        });
        return map;
    }, [items]);


    // --- ADMIN LOGIN LOGIC ---
    const handleAdminLogin = () => {
        if (adminPassword === MASTER_PASSWORD) {
            setIsAdmin(true);
            setActiveTab('admin-log');
            setAdminPassword('');
        } else {
            // Using a simple alert for a non-critical action like password failure
            alert('Invalid Admin Password');
        }
    };

    const handleAdminLogout = () => {
        setIsAdmin(false);
        setActiveTab('frontend');
    };

    if (!appInitialized) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <Loader2 className="animate-spin text-violet-700 mr-2" size={32} />
                <span className="text-xl text-gray-600">Loading Stock Data...</span>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gray-50 font-sans">
            <header className={`${PRIMARY_COLOR} p-4 shadow-xl`}>
                <div className="container mx-auto flex justify-between items-center">
                    <h1 className={`${WHITE_TEXT} text-2xl font-extrabold tracking-tight`}>
                        Mitchell & Murdoch Stock Control
                    </h1>
                    <div className="flex space-x-2">
                        {!isAdmin && (
                            <Button onClick={() => setActiveTab('admin-login')} icon={Lock} className={`${ACCENT_COLOR} ${WHITE_TEXT} text-sm`}>
                                Admin Access
                            </Button>
                        )}
                        {isAdmin && (
                            <>
                                <Button onClick={() => setActiveTab('admin-log')} icon={List} className={activeTab.startsWith('admin') ? `${ACCENT_COLOR} ${WHITE_TEXT} text-sm` : 'bg-transparent border border-white text-white hover:bg-violet-800 text-sm'}>
                                    Admin Panel
                                </Button>
                                <Button onClick={handleAdminLogout} icon={LogOut} className={`bg-red-500 hover:bg-red-600 ${WHITE_TEXT} text-sm`}>
                                    Logout
                                </Button>
                            </>
                        )}
                        {!isAdmin && (
                            <Button onClick={() => setActiveTab('frontend')} icon={Users} className={activeTab === 'frontend' ? `${ACCENT_COLOR} ${WHITE_TEXT} text-sm` : 'bg-transparent border border-white text-white hover:bg-violet-800 text-sm'}>
                                Staff View
                            </Button>
                        )}
                    </div>
                </div>
            </header>

            <main className="container mx-auto p-4 md:p-8">
                {activeTab === 'frontend' && (
                    <FrontendView
                        db={db}
                        userId={userId}
                        locations={locations}
                        items={items}
                        inventoryMap={inventoryMap}
                        itemMap={itemMap}
                        getCollectionPath={getCollectionPath}
                    />
                )}
                {activeTab === 'admin-login' && (
                    <AdminLogin
                        password={adminPassword}
                        setPassword={setAdminPassword}
                        onLogin={handleAdminLogin}
                    />
                )}
                {isAdmin && activeTab.startsWith('admin') && (
                    <AdminView
                        db={db}
                        userId={userId}
                        activeTab={activeTab}
                        setActiveTab={setActiveTab}
                        locations={locations}
                        items={items}
                        inventory={inventory}
                        itemMap={itemMap}
                        inventoryMap={inventoryMap}
                        transactions={transactions}
                        getCollectionPath={getCollectionPath}
                    />
                )}
            </main>
        </div>
    );
};

// --- FRONTEND COMPONENTS (Staff View) ---

const FrontendView = ({ db, userId, locations, items, inventoryMap, itemMap, getCollectionPath }) => {
    const [removalCart, setRemovalCart] = useState({}); // {itemId: quantity}
    const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
    const [staffName, setStaffName] = useState('');
    const [selectedLocationId, setSelectedLocationId] = useState('');
    const [isProcessing, setIsProcessing] = useState(false);

    const handleCartUpdate = (itemId, change) => {
        setRemovalCart(prev => {
            const newCount = (prev[itemId] || 0) + change;
            if (newCount < 0) return prev;
            if (newCount === 0) {
                const { [itemId]: _, ...rest } = prev;
                return rest;
            }
            return { ...prev, [itemId]: newCount };
        });
    };

    const totalCartItems = Object.values(removalCart).reduce((sum, qty) => sum + qty, 0);

    const handleCheckout = async () => {
        if (!staffName || !selectedLocationId || totalCartItems === 0) {
            // Using custom message instead of alert
            alert('Please select a location, enter your name, and add items to the cart.');
            return;
        }

        setIsProcessing(true);
        const locationName = locations.find(l => l.id === selectedLocationId)?.name || selectedLocationId;

        try {
            const transactionsRef = getCollectionPath(db, 'transactions');
            const inventoryRef = getCollectionPath(db, 'inventory');

            // Use transaction for safe stock removal
            await runTransaction(db, async (t) => {
                for (const itemId in removalCart) {
                    const quantity = removalCart[itemId];
                    const inventoryDocRef = doc(inventoryRef, `${itemId}-${selectedLocationId}`);

                    // 1. Update Inventory Level
                    const invDoc = await t.get(inventoryDocRef);
                    if (!invDoc.exists()) {
                        throw new Error(`Inventory for ${itemId} at ${selectedLocationId} not found.`);
                    }
                    const newLevel = invDoc.data().level - quantity;
                    if (newLevel < 0) {
                        throw new Error(`Insufficient stock for ${itemMap[itemId]?.name || itemId} at ${locationName}. Only ${invDoc.data().level} available.`);
                    }
                    t.update(inventoryDocRef, { level: newLevel });

                    // 2. Record Transaction Log
                    t.set(doc(transactionsRef), {
                        type: 'REMOVAL',
                        locationId: selectedLocationId,
                        locationName: locationName,
                        itemId: itemId,
                        itemName: itemMap[itemId]?.name || itemId,
                        quantity: quantity,
                        staffName: staffName,
                        timestamp: new Date().toISOString(),
                        userId: userId
                    });
                }
            });

            // Success
            alert('Stock removal successfully recorded! Thank you.');
            setRemovalCart({});
            setIsCheckoutOpen(false);
            setStaffName('');

        } catch (error) {
            console.error("Stock Removal Transaction Failed:", error);
            alert(`Stock removal failed: ${error.message}. Please check stock levels and try again.`);
        } finally {
            setIsProcessing(false);
        }
    };

    return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Left Column: Stock Levels by Location */}
            <div className="lg:col-span-2">
                <Card title="Current Stock Levels" icon={Package} className="h-full">
                    <p className="text-gray-600 mb-4">Select a location to view current stock. Check the available quantity before making a trip!</p>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-6">
                        {locations.map(loc => (
                            <button
                                key={loc.id}
                                onClick={() => setSelectedLocationId(loc.id)}
                                className={`p-3 rounded-lg text-center font-semibold transition duration-150 shadow-md ${selectedLocationId === loc.id ? `${ACCENT_COLOR} ${WHITE_TEXT} scale-105` : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                            >
                                {loc.name}
                            </button>
                        ))}
                    </div>

                    {selectedLocationId && (
                        <>
                            <h3 className={`text-lg font-bold mt-6 mb-3 border-b pb-2 ${TEXT_COLOR}`}>
                                Stock at {locations.find(l => l.id === selectedLocationId)?.name}
                            </h3>
                            <div className="space-y-3">
                                {items.map(item => {
                                    const invKey = `${selectedLocationId}-${item.id}`;
                                    const stock = inventoryMap[invKey]?.level ?? 0;
                                    const threshold = item.minThresholds?.[selectedLocationId] ?? 0;
                                    const isLow = stock <= threshold;

                                    return (
                                        <div key={item.id} className={`flex justify-between items-center p-3 rounded-lg border ${isLow ? 'bg-red-50 border-red-300' : 'bg-gray-50 border-gray-200'}`}>
                                            <div className="flex-1">
                                                <div className={`font-semibold ${TEXT_COLOR}`}>{item.name}</div>
                                                <div className={`text-sm ${isLow ? 'text-red-600 font-bold' : 'text-gray-500'}`}>
                                                    {isLow ? `LOW: ${stock} ${item.unit}s` : `${stock} ${item.unit}s available`}
                                                </div>
                                            </div>
                                            {stock > 0 && (
                                                <IconButton
                                                    icon={Plus}
                                                    title={`Add 1 ${item.name} to removal cart`}
                                                    onClick={() => handleCartUpdate(item.id, 1)}
                                                    className={`${ACCENT_COLOR} ml-4 p-3 rounded-md`}
                                                />
                                            )}
                                            {removalCart[item.id] > 0 && (
                                                <span className="ml-2 w-10 text-center font-bold text-lg">{removalCart[item.id]}</span>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </>
                    )}
                </Card>
            </div>

            {/* Right Column: Removal Cart & Checkout */}
            <div className="lg:col-span-1">
                <Card title={`Stock Removal Cart (${totalCartItems})`} icon={ShoppingCart}>
                    {totalCartItems === 0 ? (
                        <p className="text-gray-500 italic">Click the (+) button next to an item above to add it to your removal cart.</p>
                    ) : (
                        <div className="space-y-3">
                            {Object.entries(removalCart).map(([itemId, quantity]) => {
                                const item = itemMap[itemId];
                                if (!item) return null;

                                return (
                                    <div key={itemId} className="flex items-center justify-between p-3 border-b">
                                        <span className="font-medium flex-1">{item.name}</span>
                                        <div className="flex items-center space-x-2">
                                            <IconButton
                                                icon={Minus}
                                                onClick={() => handleCartUpdate(itemId, -1)}
                                                className="p-1 bg-red-500 hover:bg-red-600 text-white"
                                            />
                                            <span className="w-8 text-center font-bold">{quantity}</span>
                                            <IconButton
                                                icon={Plus}
                                                onClick={() => handleCartUpdate(itemId, 1)}
                                                className="p-1 bg-green-500 hover:bg-green-600 text-white"
                                            />
                                        </div>
                                    </div>
                                );
                            })}
                            <div className="pt-4">
                                <Button
                                    onClick={() => setIsCheckoutOpen(true)}
                                    className={`${ACCENT_COLOR} w-full`}
                                    icon={CheckCircle}
                                >
                                    Confirm Removal of {totalCartItems} Items
                                </Button>
                            </div>
                        </div>
                    )}
                </Card>
            </div>

            {/* Checkout Modal */}
            <Modal isOpen={isCheckoutOpen} onClose={() => setIsCheckoutOpen(false)} title="Confirm Stock Removal">
                <div className="space-y-4">
                    <p className="text-lg font-medium">You are removing {totalCartItems} items. Please confirm details below.</p>
                    <div>
                        <label className="block font-semibold mb-1">Staff Name</label>
                        <input
                            type="text"
                            value={staffName}
                            onChange={(e) => setStaffName(e.target.value)}
                            placeholder="Your Name"
                            className="w-full p-2 border border-gray-300 rounded-lg focus:ring-violet-700 focus:border-violet-700"
                        />
                    </div>
                    <div>
                        <label className="block font-semibold mb-1">Stock Removal Location</label>
                        <div className="grid grid-cols-2 gap-2">
                            {locations.map(loc => (
                                <button
                                    key={loc.id}
                                    onClick={() => setSelectedLocationId(loc.id)}
                                    className={`p-2 rounded-lg text-center font-semibold transition duration-150 ${selectedLocationId === loc.id ? `${ACCENT_COLOR} ${WHITE_TEXT} shadow-md` : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    {loc.name}
                                </button>
                            ))}
                        </div>
                    </div>
                    <Button
                        onClick={handleCheckout}
                        disabled={isProcessing || !staffName || !selectedLocationId || totalCartItems === 0}
                        className={`${PRIMARY_COLOR} w-full`}
                        icon={isProcessing ? Loader2 : CheckCircle}
                    >
                        {isProcessing ? 'Processing...' : `Confirm Removal from ${locations.find(l => l.id === selectedLocationId)?.name || ''}`}
                    </Button>
                </div>
            </Modal>
        </div>
    );
};

// --- ADMIN COMPONENTS ---

const AdminLogin = ({ password, setPassword, onLogin }) => (
    <Card title="Admin Login" icon={Lock} className="max-w-md mx-auto mt-10">
        <p className="text-gray-600 mb-4">Enter the master admin password to access the management panel.</p>
        <div className="space-y-4">
            <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Admin Password"
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-violet-700 focus:border-violet-700"
                onKeyDown={(e) => e.key === 'Enter' && onLogin()}
            />
            <Button onClick={onLogin} className="w-full" icon={Lock}>
                Login
            </Button>
            <p className="text-xs text-red-500 text-center">Default Password: {MASTER_PASSWORD}</p>
        </div>
    </Card>
);

const AdminView = ({ db, userId, activeTab, setActiveTab, locations, items, inventory, itemMap, inventoryMap, transactions, getCollectionPath }) => {
    const tabs = [
        { id: 'admin-log', name: 'Transactions Log', icon: List },
        { id: 'admin-low', name: 'Low Stock Monitor', icon: ArrowDown },
        { id: 'admin-mgmt', name: 'Stock & Location Mgmt', icon: Package },
        { id: 'admin-mass', name: 'Mass Stock Update', icon: ArrowUp },
        { id: 'admin-check', name: 'Stock Check/Adjustment', icon: CheckCircle },
    ];

    const lowStockItems = useMemo(() => {
        return inventory.filter(inv => {
            const item = itemMap[inv.itemId];
            if (!item) return false;
            const threshold = item.minThresholds?.[inv.locationId] ?? Infinity;
            return inv.level <= threshold;
        }).sort((a, b) => {
            // Sort by level (lowest first)
            return a.level - b.level;
        });
    }, [inventory, itemMap]);

    return (
        <div className="space-y-6">
            <Card className="p-4">
                <div className="flex flex-wrap gap-2">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex items-center px-4 py-2 rounded-lg font-semibold transition duration-150 ${activeTab === tab.id ? `${ACCENT_COLOR} ${WHITE_TEXT} shadow-md` : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                        >
                            <tab.icon size={18} className="mr-2" />
                            {tab.name}
                            {tab.id === 'admin-low' && lowStockItems.length > 0 && (
                                <span className="ml-2 px-2 py-0.5 text-xs bg-red-500 rounded-full text-white">{lowStockItems.length}</span>
                            )}
                        </button>
                    ))}
                </div>
            </Card>

            {activeTab === 'admin-log' && (
                <TransactionLog
                    transactions={transactions}
                    locations={locations}
                    items={items}
                />
            )}
            {activeTab === 'admin-low' && (
                <LowStockMonitor
                    db={db}
                    userId={userId}
                    lowStockItems={lowStockItems}
                    itemMap={itemMap}
                    locations={locations}
                    getCollectionPath={getCollectionPath}
                />
            )}
            {activeTab === 'admin-mgmt' && (
                <StockLocationManagement
                    db={db}
                    userId={userId}
                    locations={locations}
                    items={items}
                    getCollectionPath={getCollectionPath}
                />
            )}
            {activeTab === 'admin-mass' && (
                <MassStockUpdate
                    db={db}
                    userId={userId}
                    locations={locations}
                    items={items}
                    inventoryMap={inventoryMap}
                    itemMap={itemMap}
                    getCollectionPath={getCollectionPath}
                />
            )}
            {activeTab === 'admin-check' && (
                <StockCheck
                    db={db}
                    userId={userId}
                    locations={locations}
                    items={items}
                    inventoryMap={inventoryMap}
                    itemMap={itemMap}
                    getCollectionPath={getCollectionPath}
                />
            )}
        </div>
    );
};

// --- ADMIN SUB-COMPONENTS ---

const TransactionLog = ({ transactions, locations, items }) => {
    const [filterLocation, setFilterLocation] = useState('all');
    const [filterStaff, setFilterStaff] = useState('');
    const [filterItem, setFilterItem] = useState('all');

    const filteredTransactions = useMemo(() => {
        let filtered = transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort by newest first

        if (filterLocation !== 'all') {
            filtered = filtered.filter(t => t.locationId === filterLocation);
        }
        if (filterStaff) {
            filtered = filtered.filter(t => t.staffName && t.staffName.toLowerCase().includes(filterStaff.toLowerCase()));
        }
        if (filterItem !== 'all') {
            filtered = filtered.filter(t => t.itemId === filterItem);
        }
        return filtered;
    }, [transactions, filterLocation, filterStaff, filterItem]);

    const handleDownload = () => {
        const headers = ["ID", "Type", "Location", "Item Name", "Quantity", "Staff Name", "Timestamp", "Admin Note"];
        const csvRows = filteredTransactions.map(t => [
            t.id,
            t.type,
            t.locationName,
            t.itemName,
            t.type === 'REMOVAL' ? `-${t.quantity}` : `+${t.quantity}`,
            t.staffName || 'Admin',
            new Date(t.timestamp).toLocaleString(),
            t.adminNote || ''
        ].map(s => `"${String(s).replace(/"/g, '""')}"`).join(','));

        const csvString = [headers.join(','), ...csvRows].join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `stock_transactions_log_${new Date().toISOString()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    return (
        <Card title="Full Transaction Log" icon={List}>
            <div className="flex flex-wrap gap-4 mb-4">
                <div className="flex-1 min-w-[150px]">
                    <label className="block text-sm font-medium mb-1">Filter Location</label>
                    <select
                        value={filterLocation}
                        onChange={(e) => setFilterLocation(e.target.value)}
                        className="w-full p-2 border rounded-lg"
                    >
                        <option value="all">All Locations</option>
                        {locations.map(loc => <option key={loc.id} value={loc.id}>{loc.name}</option>)}
                    </select>
                </div>
                <div className="flex-1 min-w-[150px]">
                    <label className="block text-sm font-medium mb-1">Filter Item</label>
                    <select
                        value={filterItem}
                        onChange={(e) => setFilterItem(e.target.value)}
                        className="w-full p-2 border rounded-lg"
                    >
                        <option value="all">All Items</option>
                        {items.map(item => <option key={item.id} value={item.id}>{item.name}</option>)}
                    </select>
                </div>
                <div className="flex-1 min-w-[150px]">
                    <label className="block text-sm font-medium mb-1">Filter Staff Name</label>
                    <input
                        type="text"
                        value={filterStaff}
                        onChange={(e) => setFilterStaff(e.target.value)}
                        placeholder="Staff Name"
                        className="w-full p-2 border rounded-lg"
                    />
                </div>
                <div className="self-end">
                    <Button onClick={handleDownload} className={`${ACCENT_COLOR}`}>Download Log ({filteredTransactions.length} rows)</Button>
                </div>
            </div>

            <div className="overflow-x-auto rounded-lg border">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff/Admin</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type / Note</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {filteredTransactions.slice(0, 100).map(t => (
                            <tr key={t.id} className={t.type === 'REMOVAL' ? 'bg-red-50' : t.type === 'ADDITION' ? 'bg-green-50' : 'bg-yellow-50'}>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{new Date(t.timestamp).toLocaleTimeString()}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{t.locationName}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{t.itemName}</td>
                                <td className={`px-6 py-4 whitespace-nowrap text-sm font-bold ${t.type === 'REMOVAL' ? 'text-red-600' : 'text-green-600'}`}>
                                    {t.type === 'REMOVAL' ? `-${t.quantity}` : `+${t.quantity}`}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{t.staffName || 'Admin'}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {t.type} {t.adminNote && `(${t.adminNote})`}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                {filteredTransactions.length > 100 && <p className="p-4 text-center text-gray-500">Showing the first 100 transactions...</p>}
                {filteredTransactions.length === 0 && <p className="p-4 text-center text-gray-500">No transactions match your filters.</p>}
            </div>
        </Card>
    );
};

const LowStockMonitor = ({ db, userId, lowStockItems, itemMap, locations, getCollectionPath }) => {
    const [editingKey, setEditingKey] = useState(null);
    const [commentText, setCommentText] = useState('');
    const [isProcessing, setIsProcessing] = useState(false);

    const handleEditComment = (item) => {
        const key = `${item.itemId}-${item.locationId}`;
        setEditingKey(key);
        setCommentText(item.lowStockComment || '');
    };

    const handleSaveComment = async () => {
        if (!editingKey) return;
        setIsProcessing(true);
        const [itemId, locationId] = editingKey.split('-');

        try {
            const inventoryDocRef = doc(getCollectionPath(db, 'inventory'), editingKey);
            await setDoc(inventoryDocRef, { lowStockComment: commentText }, { merge: true });

            // Record a transaction for audit
            await setDoc(doc(getCollectionPath(db, 'transactions')), {
                type: 'NOTE',
                locationId: locationId,
                locationName: locations.find(l => l.id === locationId)?.name,
                itemId: itemId,
                itemName: itemMap[itemId]?.name,
                quantity: 0,
                staffName: 'Admin',
                timestamp: new Date().toISOString(),
                userId: userId,
                adminNote: `Low stock comment updated: ${commentText}`
            });

            setEditingKey(null);
        } catch (error) {
            console.error('Failed to save comment:', error);
            alert('Failed to save comment.');
        } finally {
            setIsProcessing(false);
        }
    };

    return (
        <Card title="Low Stock Monitor" icon={ArrowDown} className="bg-red-50 border border-red-200">
            <p className="text-gray-600 mb-4">Items listed below are at or below their minimum stock threshold.</p>
            {lowStockItems.length === 0 ? (
                <div className="p-6 bg-white rounded-lg text-center text-green-600 font-semibold flex items-center justify-center">
                    <CheckCircle className="mr-2" /> All stock levels are currently healthy!
                </div>
            ) : (
                <div className="space-y-4">
                    {lowStockItems.map(item => {
                        const itemDetails = itemMap[item.itemId];
                        const threshold = itemDetails?.minThresholds?.[item.locationId] ?? 0;
                        const invKey = `${item.itemId}-${item.locationId}`;

                        return (
                            <div key={invKey} className="bg-white p-4 rounded-lg shadow-sm border border-red-300">
                                <div className="flex justify-between items-start">
                                    <div className="flex-1">
                                        <div className="font-bold text-red-700 text-lg">{itemDetails?.name || item.itemId}</div>
                                        <div className="text-gray-600 text-sm">
                                            <span className="font-semibold text-violet-700">{locations.find(l => l.id === item.locationId)?.name || item.locationId}:</span>
                                            <span className="ml-2">Level: {item.level} {itemDetails?.unit || 'Units'}</span>
                                            <span className="ml-4 text-xs italic">(Threshold: {threshold})</span>
                                        </div>
                                    </div>
                                    {editingKey !== invKey && (
                                        <Button
                                            onClick={() => handleEditComment(item)}
                                            className={`${ACCENT_COLOR} text-xs`}
                                        >
                                            {item.lowStockComment ? 'Edit Comment' : 'Add Comment'}
                                        </Button>
                                    )}
                                </div>
                                {editingKey === invKey && (
                                    <div className="mt-3 p-3 bg-gray-50 rounded-lg">
                                        <label className="block text-sm font-semibold mb-1">Order/Comment Status:</label>
                                        <div className="flex space-x-2">
                                            <input
                                                type="text"
                                                value={commentText}
                                                onChange={(e) => setCommentText(e.target.value)}
                                                placeholder="e.g. Ordered 50 boxes on 25/10/2025"
                                                className="flex-1 p-2 border rounded-lg"
                                            />
                                            <Button onClick={handleSaveComment} disabled={isProcessing} className={`${PRIMARY_COLOR}`}>
                                                {isProcessing ? <Loader2 className="animate-spin" size={18} /> : 'Save'}
                                            </Button>
                                            <Button onClick={() => setEditingKey(null)} className="bg-gray-500 hover:bg-gray-600">
                                                Cancel
                                            </Button>
                                        </div>
                                    </div>
                                )}
                                {item.lowStockComment && editingKey !== invKey && (
                                    <p className="mt-2 text-sm italic text-blue-700 p-2 bg-blue-50 rounded-lg">
                                        <Truck className="inline mr-1" size={14} />
                                        {item.lowStockComment}
                                    </p>
                                )}
                            </div>
                        );
                    })}
                </div>
            )}
        </Card>
    );
};


const StockLocationManagement = ({ db, userId, locations, items, getCollectionPath }) => {
    const [newLocationName, setNewLocationName] = useState('');
    const [newItemName, setNewItemName] = useState('');
    const [newItemUnit, setNewItemUnit] = useState('Unit');
    const [itemThresholds, setItemThresholds] = useState({});
    const [selectedItemId, setSelectedItemId] = useState(null);
    const [isProcessing, setIsProcessing] = useState(false);

    // Load initial thresholds when selecting an item
    useEffect(() => {
        if (selectedItemId) {
            const item = items.find(i => i.id === selectedItemId);
            if (item) {
                setItemThresholds(item.minThresholds || {});
            }
        }
    }, [selectedItemId, items]);

    const handleAddLocation = async () => {
        if (!newLocationName.trim()) return alert('Location name cannot be empty.');
        setIsProcessing(true);
        const locationId = newLocationName.trim().replace(/\s+/g, '-').toLowerCase();

        try {
            const batch = writeBatch(db);
            const locationsRef = getCollectionPath(db, 'locations');
            const inventoryRef = getCollectionPath(db, 'inventory');
            const itemsRef = getCollectionPath(db, 'items');

            // 1. Add new location
            batch.set(doc(locationsRef, locationId), { id: locationId, name: newLocationName.trim() });

            // 2. Initialize inventory for all existing items at the new location
            const currentItems = await getDocs(itemsRef);
            currentItems.forEach(itemDoc => {
                const item = itemDoc.data();
                const invDocRef = doc(inventoryRef, `${item.id}-${locationId}`);
                // Initial stock level is 0
                batch.set(invDocRef, { itemId: item.id, locationId: locationId, level: 0, lowStockComment: '' });

                // 3. Update minimum threshold for the new location on existing items (default to 10)
                const newThresholds = { ...item.minThresholds, [locationId]: 10 };
                batch.update(doc(itemsRef, item.id), { minThresholds: newThresholds });
            });

            await batch.commit();
            setNewLocationName('');
        } catch (e) {
            console.error('Error adding location:', e);
            alert('Failed to add location.');
        } finally {
            setIsProcessing(false);
        }
    };

    const handleRemoveLocation = async (locId) => {
        if (!window.confirm(`Are you sure you want to remove the location ${locId}? This cannot be undone and will not clear existing inventory or transaction history.`)) return;
        setIsProcessing(true);
        try {
            await deleteDoc(doc(getCollectionPath(db, 'locations'), locId));
            alert('Location removed.');
        } catch (e) {
            console.error('Error removing location:', e);
            alert('Failed to remove location.');
        } finally {
            setIsProcessing(false);
        }
    };

    const handleAddNewItem = async () => {
        if (!newItemName.trim()) return alert('Item name cannot be empty.');
        setIsProcessing(true);
        const itemId = newItemName.trim().replace(/\s+/g, '-').toLowerCase();

        try {
            const batch = writeBatch(db);
            const itemsRef = getCollectionPath(db, 'items');
            const inventoryRef = getCollectionPath(db, 'inventory');

            const initialThresholds = {};
            locations.forEach(loc => { initialThresholds[loc.id] = 10; }); // Default threshold 10

            // 1. Add new Item
            batch.set(doc(itemsRef, itemId), { id: itemId, name: newItemName.trim(), unit: newItemUnit, minThresholds: initialThresholds });

            // 2. Initialize inventory for the new item across all existing locations
            locations.forEach(loc => {
                const invDocRef = doc(inventoryRef, `${itemId}-${loc.id}`);
                batch.set(invDocRef, { itemId: itemId, locationId: loc.id, level: 0, lowStockComment: '' });
            });

            await batch.commit();
            setNewItemName('');
            setNewItemUnit('Unit');
        } catch (e) {
            console.error('Error adding item:', e);
            alert('Failed to add item.');
        } finally {
            setIsProcessing(false);
        }
    };

    const handleRemoveItem = async (itemId) => {
        if (!window.confirm(`Are you sure you want to remove the item ${itemId}? This cannot be undone and will not clear existing inventory or transaction history.`)) return;
        setIsProcessing(true);
        try {
            // Remove Item definition
            await deleteDoc(doc(getCollectionPath(db, 'items'), itemId));
            // Note: Inventory documents related to this item will remain until manually cleaned,
            // but they will stop appearing as a standard item is gone.
            alert('Item definition removed. Associated inventory/transactions remain for historical data.');
        } catch (e) {
            console.error('Error removing item:', e);
            alert('Failed to remove item.');
        } finally {
            setIsProcessing(false);
        }
    };

    const handleUpdateThresholds = async () => {
        if (!selectedItemId) return;
        setIsProcessing(true);
        try {
            const itemDocRef = doc(getCollectionPath(db, 'items'), selectedItemId);
            await setDoc(itemDocRef, { minThresholds: itemThresholds }, { merge: true });
            alert('Minimum stock thresholds updated successfully.');
        } catch (e) {
            console.error('Error updating thresholds:', e);
            alert('Failed to update thresholds.');
        } finally {
            setIsProcessing(false);
    }
    };

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <Card title="Manage Locations" icon={MapPin}>
                <div className="space-y-4">
                    <div className="p-3 border rounded-lg">
                        <label className="block text-sm font-medium mb-1">New Location Name</label>
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                value={newLocationName}
                                onChange={(e) => setNewLocationName(e.target.value)}
                                placeholder="e.g. Edinburgh"
                                className="flex-1 p-2 border rounded-lg"
                            />
                            <Button onClick={handleAddLocation} disabled={isProcessing} className={`${ACCENT_COLOR}`}>
                                {isProcessing ? <Loader2 className="animate-spin" size={18} /> : 'Add'}
                            </Button>
                        </div>
                    </div>
                    <ul className="space-y-2 max-h-60 overflow-y-auto pr-2">
                        {locations.map(loc => (
                            <li key={loc.id} className="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                <span>{loc.name}</span>
                                <IconButton icon={X} onClick={() => handleRemoveLocation(loc.id)} className="bg-red-500 hover:bg-red-600 p-1" title="Remove Location" />
                            </li>
                        ))}
                    </ul>
                </div>
            </Card>

            <Card title="Manage Stock Items" icon={Package}>
                <div className="space-y-4">
                    <div className="p-3 border rounded-lg">
                        <label className="block text-sm font-medium mb-1">New Item Name / Unit</label>
                        <div className="flex space-x-2 mb-2">
                            <input
                                type="text"
                                value={newItemName}
                                onChange={(e) => setNewItemName(e.target.value)}
                                placeholder="e.g. Face Masks"
                                className="flex-1 p-2 border rounded-lg"
                            />
                        </div>
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                value={newItemUnit}
                                onChange={(e) => setNewItemUnit(e.target.value)}
                                placeholder="e.g. Unit or Box"
                                className="w-1/3 p-2 border rounded-lg"
                            />
                            <Button onClick={handleAddNewItem} disabled={isProcessing} className={`${ACCENT_COLOR} flex-1`}>
                                {isProcessing ? <Loader2 className="animate-spin" size={18} /> : 'Add New Item'}
                            </Button>
                        </div>
                    </div>
                    <ul className="space-y-2 max-h-60 overflow-y-auto pr-2">
                        {items.map(item => (
                            <li key={item.id} className="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                                <span>{item.name} ({item.unit})</span>
                                <IconButton icon={X} onClick={() => handleRemoveItem(item.id)} className="bg-red-500 hover:bg-red-600 p-1" title="Remove Item" />
                            </li>
                        ))}
                    </ul>
                </div>
            </Card>

            <Card title="Set Min Thresholds" icon={List}>
                <div className="space-y-4">
                    <select
                        value={selectedItemId || ''}
                        onChange={(e) => setSelectedItemId(e.target.value)}
                        className="w-full p-2 border rounded-lg"
                    >
                        <option value="" disabled>Select Item to Set Thresholds</option>
                        {items.map(item => <option key={item.id} value={item.id}>{item.name}</option>)}
                    </select>

                    {selectedItemId && (
                        <div className="space-y-3">
                            <h4 className="font-semibold border-b pb-1">Thresholds for {items.find(i => i.id === selectedItemId)?.name}</h4>
                            {locations.map(loc => (
                                <div key={loc.id} className="flex items-center space-x-2">
                                    <span className="w-1/2">{loc.name}:</span>
                                    <input
                                        type="number"
                                        min="0"
                                        value={itemThresholds[loc.id] || 0}
                                        onChange={(e) => setItemThresholds(prev => ({ ...prev, [loc.id]: parseInt(e.target.value) || 0 }))}
                                        className="w-1/2 p-2 border rounded-lg"
                                    />
                                </div>
                            ))}
                            <Button onClick={handleUpdateThresholds} disabled={isProcessing} className={`${PRIMARY_COLOR} w-full mt-4`}>
                                {isProcessing ? <Loader2 className="animate-spin" size={18} /> : 'Save Thresholds'}
                            </Button>
                        </div>
                    )}
                </div>
            </Card>
        </div>
    );
};

const MassStockUpdate = ({ db, userId, locations, items, inventoryMap, itemMap, getCollectionPath }) => {
    const [selectedLocationId, setSelectedLocationId] = useState('all');
    const [updateValue, setUpdateValue] = useState(0);
    const [isProcessing, setIsProcessing] = useState(false);
    const [itemUpdates, setItemUpdates] = useState({}); // {itemId: quantity}

    const isGlobalUpdate = selectedLocationId === 'all';

    const handleUpdateChange = (itemId, value) => {
        setItemUpdates(prev => ({ ...prev, [itemId]: parseInt(value) || 0 }));
    };

    const updatesToCommit = useMemo(() => {
        return Object.entries(itemUpdates).filter(([, qty]) => qty !== 0);
    }, [itemUpdates]);


    const handleMassUpdate = async () => {
        if (updatesToCommit.length === 0) return alert('No stock quantity changes entered.');
        if (updatesToCommit.some(([, qty]) => isNaN(qty))) return alert('Please enter valid numbers for stock quantities.');

        setIsProcessing(true);
        const locationsToUpdate = isGlobalUpdate ? locations.map(l => l.id) : [selectedLocationId];

        try {
            const transactionsRef = getCollectionPath(db, 'transactions');
            const inventoryRef = getCollectionPath(db, 'inventory');
            const batch = writeBatch(db);

            for (const locId of locationsToUpdate) {
                const locationName = locations.find(l => l.id === locId)?.name;

                for (const [itemId, quantity] of updatesToCommit) {
                    const item = itemMap[itemId];
                    const inventoryKey = `${itemId}-${locId}`;
                    const invDocRef = doc(inventoryRef, inventoryKey);
                    const currentLevel = inventoryMap[inventoryKey]?.level || 0;
                    const newLevel = currentLevel + quantity;

                    if (newLevel < 0) {
                        alert(`Mass update failed: Stock for ${item?.name} at ${locationName} would become negative (${newLevel}). Skipping this update.`);
                        continue;
                    }

                    // 1. Update Inventory Level
                    batch.update(invDocRef, { level: newLevel });

                    // 2. Record Transaction Log
                    batch.set(doc(transactionsRef), {
                        type: 'ADDITION',
                        locationId: locId,
                        locationName: locationName,
                        itemId: itemId,
                        itemName: item?.name,
                        quantity: quantity,
                        staffName: 'Admin (Mass Update)',
                        timestamp: new Date().toISOString(),
                        userId: userId,
                        adminNote: `Mass update of ${quantity} at ${isGlobalUpdate ? 'All Sites' : locationName}`
                    });
                }
            }

            await batch.commit();
            alert('Mass stock update successful!');
            setItemUpdates({}); // Clear updates
        } catch (error) {
            console.error("Mass Stock Update Failed:", error);
            alert(`Mass stock update failed: ${error.message}`);
        } finally {
            setIsProcessing(false);
        }
    };

    return (
        <Card title="Mass Stock Update" icon={Truck}>
            <p className="text-gray-600 mb-4">Add or subtract stock from a single site or all sites at once.</p>
            <div className="mb-6 flex space-x-4 items-center">
                <label className="font-semibold min-w-[100px]">Select Location:</label>
                <div className="flex space-x-2 flex-1">
                    <button
                        onClick={() => setSelectedLocationId('all')}
                        className={`p-2 rounded-lg font-semibold transition duration-150 ${isGlobalUpdate ? `${ACCENT_COLOR} ${WHITE_TEXT}` : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                    >
                        All Sites (Global)
                    </button>
                    <select
                        value={selectedLocationId}
                        onChange={(e) => setSelectedLocationId(e.target.value)}
                        className="p-2 border rounded-lg flex-1"
                        disabled={isGlobalUpdate}
                    >
                        <option value="all" disabled={!isGlobalUpdate}>Select Single Site...</option>
                        {locations.map(loc => <option key={loc.id} value={loc.id}>{loc.name}</option>)}
                    </select>
                </div>
            </div>

            <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                {items.map(item => {
                    const currentLevel = isGlobalUpdate ? 'Varies' : inventoryMap[`${selectedLocationId}-${item.id}`]?.level ?? 0;

                    return (
                        <div key={item.id} className="flex items-center space-x-4 p-3 border rounded-lg bg-gray-50">
                            <span className="font-semibold flex-1">{item.name} ({item.unit})</span>
                            <span className="text-sm text-gray-500 w-20">
                                Current: {currentLevel}
                            </span>
                            <input
                                type="number"
                                placeholder="Qty Change (+/-)"
                                value={itemUpdates[item.id] === undefined ? '' : itemUpdates[item.id]}
                                onChange={(e) => handleUpdateChange(item.id, e.target.value)}
                                className="w-24 p-2 border rounded-lg text-center"
                            />
                            <span className={`w-16 font-bold ${itemUpdates[item.id] > 0 ? 'text-green-600' : itemUpdates[item.id] < 0 ? 'text-red-600' : 'text-gray-500'}`}>
                                {itemUpdates[item.id] > 0 ? `+${itemUpdates[item.id]}` : itemUpdates[item.id] || 0}
                            </span>
                        </div>
                    );
                })}
            </div>

            <Button
                onClick={handleMassUpdate}
                disabled={isProcessing || updatesToCommit.length === 0 || isGlobalUpdate && selectedLocationId !== 'all'}
                className={`${PRIMARY_COLOR} w-full mt-6`}
                icon={isProcessing ? Loader2 : Truck}
            >
                {isProcessing ? 'Applying Update...' : `Apply Mass Update to ${isGlobalUpdate ? 'All Sites' : locations.find(l => l.id === selectedLocationId)?.name || ''}`}
            </Button>
        </Card>
    );
};

const StockCheck = ({ db, userId, locations, items, inventoryMap, itemMap, getCollectionPath }) => {
    const [selectedLocationId, setSelectedLocationId] = useState(locations[0]?.id || '');
    const [counts, setCounts] = useState({}); // {itemId: actualCount}
    const [isProcessing, setIsProcessing] = useState(false);

    useEffect(() => {
        // Reset counts when location changes
        const initialCounts = {};
        items.forEach(item => {
            const invKey = `${selectedLocationId}-${item.id}`;
            initialCounts[item.id] = inventoryMap[invKey]?.level ?? 0;
        });
        setCounts(initialCounts);
    }, [selectedLocationId, items, inventoryMap]);

    const handleCountChange = (itemId, value) => {
        setCounts(prev => ({ ...prev, [itemId]: parseInt(value) || 0 }));
    };

    const handleApplyAdjustment = async () => {
        if (!selectedLocationId) return alert('Please select a location.');
        setIsProcessing(true);

        const locationName = locations.find(l => l.id === selectedLocationId)?.name;
        const transactionsRef = getCollectionPath(db, 'transactions');
        const inventoryRef = getCollectionPath(db, 'inventory');
        const batch = writeBatch(db);
        let adjustmentsMade = 0;

        try {
            for (const itemId in counts) {
                const item = itemMap[itemId];
                const actualCount = counts[itemId];
                const inventoryKey = `${selectedLocationId}-${itemId}`;
                const currentLevel = inventoryMap[inventoryKey]?.level || 0;
                const difference = actualCount - currentLevel;

                if (difference !== 0) {
                    adjustmentsMade++;
                    const invDocRef = doc(inventoryRef, inventoryKey);

                    // 1. Update Inventory Level
                    batch.update(invDocRef, { level: actualCount });

                    // 2. Record Transaction Log
                    batch.set(doc(transactionsRef), {
                        type: 'ADJUSTMENT',
                        locationId: selectedLocationId,
                        locationName: locationName,
                        itemId: itemId,
                        itemName: item?.name,
                        quantity: Math.abs(difference),
                        staffName: 'Admin (Stock Check)',
                        timestamp: new Date().toISOString(),
                        userId: userId,
                        adminNote: `Stock count adjusted from ${currentLevel} to ${actualCount} (${difference > 0 ? 'Increase' : 'Decrease'})`
                    });
                }
            }

            if (adjustmentsMade > 0) {
                await batch.commit();
                alert(`${adjustmentsMade} stock items adjusted successfully at ${locationName}.`);
            } else {
                alert('No adjustments needed. Stock count matches system records.');
            }

        } catch (error) {
            console.error("Stock Check Adjustment Failed:", error);
            alert(`Stock check adjustment failed: ${error.message}`);
        } finally {
            setIsProcessing(false);
        }
    };

    const isDirty = useMemo(() => {
        return items.some(item => {
            const invKey = `${selectedLocationId}-${item.id}`;
            const currentLevel = inventoryMap[invKey]?.level ?? 0;
            return (counts[item.id] || 0) !== currentLevel;
        });
    }, [counts, selectedLocationId, items, inventoryMap]);

    return (
        <Card title="Stock Check Area (Inventory Adjustment)" icon={CheckCircle}>
            <p className="text-gray-600 mb-4">Enter the *actual* physical count for each item. The system will calculate and log the difference.</p>
            <div className="mb-6 flex space-x-4 items-center">
                <label className="font-semibold min-w-[100px]">Select Location:</label>
                <div className="flex-1">
                    <select
                        value={selectedLocationId}
                        onChange={(e) => setSelectedLocationId(e.target.value)}
                        className="p-2 border rounded-lg w-full"
                    >
                        {locations.map(loc => <option key={loc.id} value={loc.id}>{loc.name}</option>)}
                    </select>
                </div>
            </div>

            <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                {items.map(item => {
                    const invKey = `${selectedLocationId}-${item.id}`;
                    const currentLevel = inventoryMap[invKey]?.level ?? 0;
                    const isAdjusted = (counts[item.id] || 0) !== currentLevel;
                    const difference = (counts[item.id] || 0) - currentLevel;

                    return (
                        <div key={item.id} className={`flex items-center space-x-4 p-3 border rounded-lg ${isAdjusted ? 'bg-yellow-100 border-yellow-400' : 'bg-gray-50 border-gray-200'}`}>
                            <span className="font-semibold flex-1">{item.name} ({item.unit})</span>
                            <span className="text-sm text-gray-500 w-20">
                                System: {currentLevel}
                            </span>
                            <input
                                type="number"
                                min="0"
                                placeholder="Actual Count"
                                value={counts[item.id]}
                                onChange={(e) => handleCountChange(item.id, e.target.value)}
                                className="w-24 p-2 border rounded-lg text-center font-bold"
                            />
                            <span className={`w-16 font-bold text-sm ${difference > 0 ? 'text-green-600' : difference < 0 ? 'text-red-600' : 'text-gray-500'}`}>
                                {isAdjusted ? (difference > 0 ? `+${difference}` : difference) : 'Match'}
                            </span>
                        </div>
                    );
                })}
            </div>

            <Button
                onClick={handleApplyAdjustment}
                disabled={isProcessing || !isDirty}
                className={`${ACCENT_COLOR} w-full mt-6`}
                icon={isProcessing ? Loader2 : CheckCircle}
            >
                {isProcessing ? 'Applying Adjustments...' : 'Apply Stock Check Adjustments'}
            </Button>
            {!isDirty && <p className="mt-2 text-center text-gray-500 text-sm">No changes detected yet.</p>}
        </Card>
    );
};


ReactDOM.render(<App />, document.getElementById('root'));
// --- REACT APPLICATION CODE END ---
    </script>
</body>
</html>
