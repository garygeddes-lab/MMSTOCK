<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Stock Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --danger: #ef4444;
            --danger-light: #f87171;
            --success: #10b981;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: var(--primary); color: white; padding: 8px 16px; border-radius: 8px; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--primary-light); }
        .btn-danger { background-color: var(--danger); color: white; padding: 8px 16px; border-radius: 8px; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: var(--danger-light); }
        .input-text { border: 1px solid #d1d5db; padding: 8px 12px; border-radius: 8px; width: 100%; }
        .low-stock { background-color: #fee2e2; color: #991b1b; font-weight: 600; }
        .pending-removal-item { background-color: #fffbeb; border-left: 4px solid #f59e0b; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 12px 16px; text-align: left; }
        th { background-color: #e5e7eb; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        tr:nth-child(even) { background-color: #f9fafb; }
        tr:last-child td:first-child { border-bottom-left-radius: 8px; }
        tr:last-child td:last-child { border-bottom-right-radius: 8px; }
        .table-container { overflow-x: auto; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">Site Stock Management Dashboard</h1>

        <div id="auth-status" class="mb-4 text-sm text-gray-600">
            Connecting to database...
        </div>
        <div id="loading" class="text-center py-8 text-lg font-medium text-indigo-600 hidden">
            <div class="animate-spin inline-block w-6 h-6 border-4 border-indigo-500 border-t-transparent rounded-full mr-2"></div>
            Loading stock data...
        </div>
        <div id="error-message" class="card p-4 mb-4 bg-red-100 text-red-700 hidden"></div>

        <!-- Main Stock View -->
        <div id="main-view" class="space-y-6 hidden">
            <div class="card p-5 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div class="mb-4 sm:mb-0">
                    <label for="site-select" class="block text-sm font-medium text-gray-700 mb-1">Current Site</label>
                    <select id="site-select" class="input-text w-full sm:w-auto"></select>
                </div>
                <div>
                    <!-- Admin password is 'admin' -->
                    <button id="admin-mode-toggle" class="btn-primary">Admin Mode: Off</button>
                </div>
            </div>

            <div class="card table-container">
                <table id="stock-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Item</th>
                            <th>Current Stock</th>
                            <th>Low Threshold</th>
                            <th class="rounded-tr-lg">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Stock rows will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Pending Removal Cart -->
            <div id="removal-cart" class="card p-5 hidden">
                <h3 class="text-xl font-semibold mb-3 border-b pb-2 text-gray-800">Pending Removal</h3>
                <div id="pending-list" class="space-y-3 mb-4">
                    <p class="text-gray-500" id="empty-cart-message">No items staged for removal.</p>
                </div>
                <button id="confirm-removal-btn" class="btn-danger w-full sm:w-auto" disabled>
                    Confirm Removal of 0 Items
                </button>
            </div>
        </div>

        <!-- Admin Panel (Initially Hidden) -->
        <div id="admin-panel" class="mt-8 card p-5 space-y-4 hidden">
            <h2 class="text-2xl font-bold text-gray-800">Admin Panel (Manage Items)</h2>

            <!-- Item List -->
            <div id="admin-item-list" class="space-y-3">
                <!-- Item management rows will be inserted here -->
            </div>

            <!-- Add New Item Form -->
            <div class="pt-4 border-t mt-4">
                <h3 class="text-xl font-semibold mb-3">Add New Item</h3>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <input type="text" id="new-item-name" placeholder="Item Name (e.g., Safety Goggles)" class="input-text flex-grow">
                    <input type="number" id="new-item-threshold" placeholder="Low Threshold (e.g., 50)" value="50" class="input-text w-full sm:w-40">
                    <button id="add-new-item-btn" class="btn-primary w-full sm:w-auto">Add Item</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal Structure (Replaces alert, confirm, and prompt) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="card p-6 w-11/12 max-w-md" role="alertdialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-message">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>

            <div id="modal-input-container" class="mb-4 hidden">
                <input type="password" id="modal-input" class="input-text" placeholder="Enter password" autocomplete="off">
            </div>

            <div id="modal-actions" class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 hidden">Cancel</button>
                <button id="modal-confirm-btn" class="btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // --- CORRECTED IMPORTS: setLogLevel is removed as it's not exported here. ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, writeBatch, runTransaction, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // --- END CORRECTED IMPORTS ---
        
        // Global state for application
        let firebaseApp, db, auth, userId = null;
        let isAuthReady = false;
        let siteData = {}; // Stores all stock levels: { siteId: { itemId: quantity } }
        let itemDefinitions = {}; // Stores item details: { itemId: { name: '...', threshold: 50 } }
        let currentSite = 'Dundee';
        let isBatching = false;
        let adminMode = false;

        const sites = ['Dundee', 'Perth', 'Edinburgh', 'Glasgow'];
        const pendingRemoval = {}; // { itemId: quantity }

        // --- Core Firebase Setup & Global Elements ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let firebaseConfig = null;
        const rawConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        
        // --- DEBUGGING LOG ADDED HERE ---
        console.log("DEBUG: Raw __firebase_config string:", rawConfig); 
        // ---------------------------------
        
        if (rawConfig) {
            try {
                firebaseConfig = JSON.parse(rawConfig);
            } catch (e) {
                console.error("Failed to parse __firebase_config string:", e);
                // firebaseConfig remains null, triggering the error path below
            }
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const authStatusEl = document.getElementById('auth-status');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error-message');
        const mainViewEl = document.getElementById('main-view');

        // Firestore Paths (CRITICAL for security rules)
        const itemDefsPath = `/artifacts/${appId}/public/data/item_definitions`;
        const stockLevelsDocPath = `/artifacts/${appId}/public/data/stock_levels/levels`;

        // Utility to display errors
        function displayError(message) {
            console.error(message);
            errorEl.textContent = `Error: ${message}`;
            errorEl.classList.remove('hidden');
            loadingEl.classList.add('hidden');
        }

        // --- Custom Modal (Replaces alert, confirm, prompt) ---
        function showCustomModal({ title, message, type = 'alert', onSubmit = () => {}, onCancel = () => {} }) {
            const modalEl = document.getElementById('custom-modal');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const inputContainerEl = document.getElementById('modal-input-container');
            const inputEl = document.getElementById('modal-input');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            // Reset UI
            titleEl.textContent = title;
            messageEl.textContent = message;
            inputContainerEl.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            confirmBtn.className = 'btn-primary';
            inputEl.value = '';
            
            // Setup based on type
            if (type === 'confirm' || type === 'prompt') {
                cancelBtn.classList.remove('hidden');
                confirmBtn.textContent = (type === 'confirm') ? 'Confirm' : 'Submit';
                confirmBtn.className = type === 'confirm' ? 'btn-danger' : 'btn-primary';
            } else {
                confirmBtn.textContent = 'OK';
            }

            if (type === 'prompt') {
                inputContainerEl.classList.remove('hidden');
                inputEl.focus();
                inputEl.type = title.toLowerCase().includes("password") ? "password" : "text"; // Set input type dynamically
            }

            // Handlers
            confirmBtn.onclick = () => {
                modalEl.classList.add('hidden');
                const result = type === 'prompt' ? inputEl.value : true;
                onSubmit(result);
            };

            cancelBtn.onclick = () => {
                modalEl.classList.add('hidden');
                onCancel();
            };

            modalEl.classList.remove('hidden');
        }


        // --- Initialization ---
        async function initializeFirebase() {
            if (!firebaseConfig) { // This is the check that fails
                authStatusEl.textContent = 'Firebase Config Missing. Cannot connect to database.';
                displayError("Firebase configuration is missing. Cannot initialize Firestore.");
                return;
            }

            try {
                // Initialize App and Services
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);

                // Sign in with platform token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    authStatusEl.textContent = 'Connected (Authenticated)';
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    authStatusEl.textContent = 'Connected (Anonymous Fallback)';
                    console.warn("Signed in anonymously as no custom token was available.");
                }

                // Wait for auth state to be ready
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log(`User ID: ${userId}`);
                        startListeners();
                        // This is a one-time operation after auth is successful
                        seedDefaultData();
                        mainViewEl.classList.remove('hidden');
                        loadingEl.classList.add('hidden');
                    } else {
                        // Should not happen as we force anonymous sign-in
                        displayError("Authentication failed. Cannot access Firestore.");
                    }
                });


            } catch (e) {
                displayError(`Firebase Initialization Failed: ${e.message}`);
            }
        }

        // --- Data Seeding ---
        async function seedDefaultData() {
            // Check if item definitions exist before seeding
            try {
                const itemColRef = collection(db, itemDefsPath);
                const itemsSnapshot = await getDocs(itemColRef);

                if (itemsSnapshot.empty) {
                    console.log("Seeding default data...");
                    const batch = writeBatch(db);

                    const defaultItems = [
                        { id: 'item_gloves', name: 'Safety Gloves', threshold: 50 },
                        { id: 'item_glasses', name: 'Safety Glasses', threshold: 30 },
                        { id: 'item_hats', name: 'Hard Hats', threshold: 25 }
                    ];

                    defaultItems.forEach(item => {
                        const itemRef = doc(db, `${itemDefsPath}/${item.id}`);
                        batch.set(itemRef, { name: item.name, threshold: item.threshold, id: item.id });
                    });

                    // Set initial stock (100 for all items, all sites)
                    const initialStock = {};
                    sites.forEach(site => {
                        initialStock[site] = {};
                        defaultItems.forEach(item => {
                            initialStock[site][item.id] = 100;
                        });
                    });

                    const stockRef = doc(db, stockLevelsDocPath);
                    batch.set(stockRef, initialStock);

                    await batch.commit();
                    console.log("Default data seeded successfully.");
                } else {
                    console.log("Existing data found. Skipping seed.");
                }
            } catch (e) {
                displayError(`Failed to seed data: ${e.message}`);
            }
        }

        // --- Firestore Listeners ---
        function startListeners() {
            // Listener for Item Definitions
            onSnapshot(collection(db, itemDefsPath), (snapshot) => {
                const newDefs = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    newDefs[doc.id] = { ...data, id: doc.id };
                });
                itemDefinitions = newDefs;
                renderStockTable();
                if (adminMode) renderAdminPanel();
            }, (error) => displayError(`Error loading item definitions: ${error.message}`));

            // Listener for Stock Levels
            onSnapshot(doc(db, stockLevelsDocPath), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    siteData = docSnapshot.data();
                } else {
                    siteData = {};
                    console.warn("Stock levels document does not exist. Creating default document if necessary.");
                }
                renderStockTable();
            }, (error) => displayError(`Error loading stock levels: ${error.message}`));
        }


        // --- Stock Update Logic (CRITICAL: Uses Transaction) ---
        async function updateStockInFirestore(itemId, change) {
            if (!isAuthReady) return displayError("Authentication not ready. Cannot update stock.");

            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockRef);

                    if (!stockDoc.exists()) {
                        throw "Stock levels document does not exist!";
                    }

                    const currentLevels = stockDoc.data();
                    const siteLevels = currentLevels[currentSite] || {};
                    const currentStock = siteLevels[itemId] || 0;
                    const newStock = Math.max(0, currentStock + change);

                    // Update the local site's stock level for this item
                    siteLevels[itemId] = newStock;
                    currentLevels[currentSite] = siteLevels;

                    // Write the entire updated map back to the document
                    transaction.set(stockRef, currentLevels);
                });
                console.log(`Stock for ${itemId} updated successfully (Change: ${change}).`);

            } catch (e) {
                displayError(`Transaction Failed (Stock Update): ${e.message}`);
            }
        }

        // --- UI Rendering ---

        // Site Dropdown Setup
        const siteSelectEl = document.getElementById('site-select');
        sites.forEach(site => {
            const option = document.createElement('option');
            option.value = site;
            option.textContent = site;
            siteSelectEl.appendChild(option);
        });
        siteSelectEl.value = currentSite;
        siteSelectEl.addEventListener('change', (e) => {
            currentSite = e.target.value;
            renderStockTable();
            updateRemovalCartUI(); // Reset cart view on site switch
        });

        function renderStockTable() {
            const tableBody = document.querySelector('#stock-table tbody');
            tableBody.innerHTML = '';
            // Sort items alphabetically by name
            const itemIds = Object.keys(itemDefinitions).sort((a, b) => itemDefinitions[a].name.localeCompare(itemDefinitions[b].name));

            if (itemIds.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">No items defined yet. Please check Admin Panel.</td></tr>';
                return;
            }

            itemIds.forEach(itemId => {
                const item = itemDefinitions[itemId];
                const siteLevels = siteData[currentSite] || {};
                const currentStock = siteLevels[itemId] || 0;
                const isLow = currentStock <= item.threshold;

                const row = document.createElement('tr');
                // Use default class if not low stock, otherwise apply low-stock style
                row.className = isLow ? 'low-stock' : 'bg-white'; 

                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${currentStock}</td>
                    <td>${item.threshold}</td>
                    <td>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center">
                            <input type="number" data-item-id="${itemId}" class="input-text w-20 text-center quantity-input" placeholder="Qty" value="1" min="1">
                            <button class="btn-primary restock-btn whitespace-nowrap" data-item-id="${itemId}">Restock</button>
                            <button class="btn-danger remove-btn whitespace-nowrap" data-item-id="${itemId}">Remove</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Re-attach event listeners after rendering
            document.querySelectorAll('.restock-btn').forEach(btn => btn.addEventListener('click', handleRestock));
            document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', handleStageRemoval));
        }

        // --- Stock Action Handlers ---

        function getQuantity(itemId) {
            const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
            const quantity = parseInt(input?.value, 10);
            return (quantity > 0) ? quantity : 1;
        }

        function handleRestock(e) {
            const itemId = e.target.getAttribute('data-item-id');
            const quantity = getQuantity(itemId);
            updateStockInFirestore(itemId, quantity);
        }

        function handleStageRemoval(e) {
            const itemId = e.target.getAttribute('data-item-id');
            const quantity = getQuantity(itemId);
            
            // Check if there is enough stock before staging for removal
            const availableStock = (siteData[currentSite] && siteData[currentSite][itemId]) || 0;
            const currentlyStaged = pendingRemoval[itemId] || 0;
            const potentialNewStock = availableStock - currentlyStaged - quantity;

            if (potentialNewStock < 0) {
                return showCustomModal({
                    title: "Stock Limit Reached",
                    message: `Cannot stage ${quantity} of ${itemDefinitions[itemId].name} for removal. You only have ${availableStock - currentlyStaged} items remaining after considering the current cart.`,
                    type: 'alert'
                });
            }


            if (pendingRemoval[itemId]) {
                pendingRemoval[itemId] += quantity;
            } else {
                pendingRemoval[itemId] = quantity;
            }

            // Clear input after staging
            const inputEl = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
            if(inputEl) inputEl.value = 1;

            updateRemovalCartUI();
        }

        function updateRemovalCartUI() {
            const listEl = document.getElementById('pending-list');
            const confirmBtn = document.getElementById('confirm-removal-btn');
            const itemIds = Object.keys(pendingRemoval).filter(id => pendingRemoval[id] > 0);
            let totalItems = 0;

            listEl.innerHTML = '';
            document.getElementById('empty-cart-message')?.remove();

            if (itemIds.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500" id="empty-cart-message">No items staged for removal.</p>';
                confirmBtn.textContent = 'Confirm Removal of 0 Items';
                confirmBtn.disabled = true;
                document.getElementById('removal-cart').classList.add('hidden');
                return;
            }

            document.getElementById('removal-cart').classList.remove('hidden');

            itemIds.forEach(itemId => {
                const quantity = pendingRemoval[itemId];
                if (quantity > 0) {
                    const item = itemDefinitions[itemId];
                    totalItems += quantity;
                    const div = document.createElement('div');
                    div.className = 'pending-removal-item p-3 flex justify-between items-center rounded';
                    div.innerHTML = `
                        <span>${item ? item.name : itemId} (${currentSite}): <strong>${quantity}</strong> staged</span>
                        <button class="text-sm text-red-600 hover:text-red-800 clear-item-btn" data-item-id="${itemId}">Clear</button>
                    `;
                    listEl.appendChild(div);
                }
            });

            confirmBtn.textContent = `Confirm Removal of ${totalItems} Items`;
            confirmBtn.disabled = totalItems === 0;

            document.querySelectorAll('.clear-item-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const itemId = e.target.getAttribute('data-item-id');
                delete pendingRemoval[itemId];
                updateRemovalCartUI();
            }));
        }

        // --- Confirm Removal Handler (Batch Write Transaction) ---
        document.getElementById('confirm-removal-btn').addEventListener('click', async () => {
            if (!isAuthReady || isBatching) return;
            isBatching = true;
            document.getElementById('confirm-removal-btn').disabled = true;
            document.getElementById('confirm-removal-btn').textContent = 'Processing...';

            // Clone and clear cart *before* transaction attempt
            const itemsToCommit = { ...pendingRemoval };
            Object.keys(pendingRemoval).forEach(key => delete pendingRemoval[key]);
            updateRemovalCartUI(); 

            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    const stockDoc = await transaction.get(stockRef);
                    if (!stockDoc.exists()) throw "Stock levels document does not exist!";

                    const currentLevels = stockDoc.data();
                    let siteLevels = currentLevels[currentSite] || {};

                    for (const itemId in itemsToCommit) {
                        const quantityToRemove = itemsToCommit[itemId];
                        const currentStock = siteLevels[itemId] || 0;
                        const newStock = Math.max(0, currentStock - quantityToRemove);
                        siteLevels[itemId] = newStock;
                    }

                    currentLevels[currentSite] = siteLevels;
                    transaction.set(stockRef, currentLevels);
                });
                console.log(`Batch removal committed successfully.`);
            } catch (e) {
                displayError(`Transaction Failed (Batch Removal): ${e.message}`);
                // In a real application, you'd re-add the items to pendingRemoval if the transaction failed, 
                // but for simplicity here, we rely on the error logging.
            } finally {
                isBatching = false;
                // Re-rendering the table/cart takes care of updating the button state.
            }
        });

        // --- Admin Mode Logic ---

        document.getElementById('admin-mode-toggle').addEventListener('click', () => {
            if (adminMode) {
                adminMode = false;
                document.getElementById('admin-mode-toggle').textContent = 'Admin Mode: Off';
                document.getElementById('admin-panel').classList.add('hidden');
                return;
            }

            showCustomModal({
                title: "Admin Access Required",
                message: "Please enter the admin password to manage item definitions. (Hint: 'admin')",
                type: 'prompt',
                onSubmit: (password) => {
                    if (password === 'admin') {
                        adminMode = true;
                        document.getElementById('admin-mode-toggle').textContent = 'Admin Mode: On (Click to exit)';
                        document.getElementById('admin-panel').classList.remove('hidden');
                        renderAdminPanel();
                    } else {
                        showCustomModal({
                            title: "Access Denied",
                            message: "The password entered was incorrect.",
                            type: 'alert'
                        });
                    }
                }
            });
        });

        function renderAdminPanel() {
            const listEl = document.getElementById('admin-item-list');
            listEl.innerHTML = '';
            const itemIds = Object.keys(itemDefinitions).sort((a, b) => itemDefinitions[a].name.localeCompare(itemDefinitions[b].name));

            itemIds.forEach(itemId => {
                const item = itemDefinitions[itemId];
                const div = document.createElement('div');
                div.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 p-3 card';
                div.innerHTML = `
                    <input type="text" data-field="name" value="${item.name}" placeholder="Item Name" class="input-text flex-grow">
                    <input type="number" data-field="threshold" value="${item.threshold}" placeholder="Threshold" class="input-text w-full sm:w-32">
                    <button class="btn-primary save-def-btn w-full sm:w-24" data-item-id="${itemId}">Save</button>
                    <button class="btn-danger delete-def-btn w-full sm:w-24" data-item-id="${itemId}">Delete</button>
                `;
                listEl.appendChild(div);
            });

            document.querySelectorAll('.save-def-btn').forEach(btn => btn.addEventListener('click', handleSaveItemDefinition));
            document.querySelectorAll('.delete-def-btn').forEach(btn => btn.addEventListener('click', handleDeleteItemDefinition));
        }

        async function handleSaveItemDefinition(e) {
            const itemId = e.target.getAttribute('data-item-id');
            const parent = e.target.closest('div');
            const newName = parent.querySelector('[data-field="name"]').value.trim();
            const newThreshold = parseInt(parent.querySelector('[data-field="threshold"]').value, 10);

            if (!newName || isNaN(newThreshold) || newThreshold < 0) {
                return showCustomModal({
                    title: "Invalid Input",
                    message: "Please enter a valid item name and a non-negative threshold.",
                    type: 'alert'
                });
            }

            const itemRef = doc(db, `${itemDefsPath}/${itemId}`);
            try {
                // Update the item definition document
                await setDoc(itemRef, { name: newName, threshold: newThreshold, id: itemId }, { merge: true });
                console.log(`Item definition for ${itemId} updated.`);
            } catch (e) {
                displayError(`Failed to save item definition: ${e.message}`);
            }
        }

        // --- Add New Item ---
        document.getElementById('add-new-item-btn').addEventListener('click', async () => {
            const nameEl = document.getElementById('new-item-name');
            const thresholdEl = document.getElementById('new-item-threshold');
            const name = nameEl.value.trim();
            const threshold = parseInt(thresholdEl.value, 10);

            if (!name || isNaN(threshold) || threshold < 0) {
                return showCustomModal({
                    title: "Invalid Input",
                    message: "Please enter a valid item name and a non-negative threshold.",
                    type: 'alert'
                });
            }

            const itemId = 'item_' + name.toLowerCase().replace(/[^a-z0-9]+/g, '_');
            const itemRef = doc(db, `${itemDefsPath}/${itemId}`);
            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Check/Add Item Definition
                    transaction.set(itemRef, { name: name, threshold: threshold, id: itemId });

                    // 2. Update Stock Levels for all sites
                    const stockDoc = await transaction.get(stockRef);
                    const currentLevels = stockDoc.exists() ? stockDoc.data() : {};
                    
                    sites.forEach(site => {
                        if (!currentLevels[site]) currentLevels[site] = {};
                        // Set initial stock to 100 for the new item at all sites
                        currentLevels[site][itemId] = 100;
                    });
                    transaction.set(stockRef, currentLevels);
                });

                nameEl.value = '';
                thresholdEl.value = '50';
                console.log(`New item ${name} added successfully.`);
            } catch (e) {
                displayError(`Failed to add new item in transaction: ${e.message}`);
            }
        });
        
        // Extracted transaction logic for deletion
        async function performDeletion(itemId) {
            const itemDefRef = doc(db, `${itemDefsPath}/${itemId}`);
            const stockRef = doc(db, stockLevelsDocPath);

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Delete Item Definition
                    transaction.delete(itemDefRef); 

                    // 2. Remove Item from Stock Levels across all sites
                    const stockDoc = await transaction.get(stockRef);
                    if (stockDoc.exists()) {
                        const currentLevels = stockDoc.data();
                        sites.forEach(site => {
                            if (currentLevels[site] && currentLevels[site][itemId] !== undefined) {
                                delete currentLevels[site][itemId];
                            }
                        });
                        transaction.set(stockRef, currentLevels);
                    }
                });
                console.log(`Item ${itemId} deleted successfully.`);
            } catch (e) {
                displayError(`Failed to delete item in transaction: ${e.message}`);
            }
        }

        function handleDeleteItemDefinition(e) {
            const itemId = e.target.getAttribute('data-item-id');
            const itemName = itemDefinitions[itemId]?.name || itemId;

            showCustomModal({
                title: "Confirm Deletion",
                message: `Are you absolutely sure you want to delete "${itemName}"? This action is permanent and will remove the item from ALL sites.`,
                type: 'confirm',
                onSubmit: () => {
                    performDeletion(itemId);
                },
                onCancel: () => {
                    console.log("Deletion cancelled.");
                }
            });
        }


        // Initial setup call
        loadingEl.classList.remove('hidden');
        initializeFirebase();

    </script>
</body>
</html>
